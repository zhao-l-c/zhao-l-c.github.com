
 <!DOCTYPE HTML>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
  
    <title>Struts2完全教程（5）- 文件上传下载，表单重复提交和自定义拦截器 | LC的笔记</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="zlc">
    
    <meta name="description" content="文件上传
文件上传的功能是由FileUploadInterceptor拦截器扩展的，查看这个拦截器的javadoc了解具体的用法。
简单示例
首先，提交 表单需要注意的3点：

须把 HTML 表单的 enctype 属性设置为 multipart/form-data；
须把 HTML 表单的met">
    
    
    
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="LC的笔记" title="LC的笔记"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="LC的笔记">LC的笔记</a></h1>
				<h2 class="blog-motto">好记性不如烂笔头</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:yoursite.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/04/27/Java/Struts2/Struts2完全教程（5）- 文件上传下载，表单重复提交和自定义拦截器/" title="Struts2完全教程（5）- 文件上传下载，表单重复提交和自定义拦截器" itemprop="url">Struts2完全教程（5）- 文件上传下载，表单重复提交和自定义拦截器</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://yoursite.com" title="zlc">zlc</a>
    </p>
  <p class="article-time">
    <time datetime="2015-04-27T11:05:15.000Z" itemprop="datePublished">4月 27 2015</time>
    Updated:<time datetime="2015-04-27T11:05:15.000Z" itemprop="dateModified">4月 27 2015</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#文件上传"><span class="toc-number">1.</span> <span class="toc-text">文件上传</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#简单示例"><span class="toc-number">1.1.</span> <span class="toc-text">简单示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#提交多个文件"><span class="toc-number">1.2.</span> <span class="toc-text">提交多个文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#限制上传文件"><span class="toc-number">1.3.</span> <span class="toc-text">限制上传文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#文件上传错误消息处理"><span class="toc-number">1.4.</span> <span class="toc-text">文件上传错误消息处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#文件下载"><span class="toc-number">2.</span> <span class="toc-text">文件下载</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#type=”stream”的result元素"><span class="toc-number">2.1.</span> <span class="toc-text">type=”stream”的result元素</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#简单示例-1"><span class="toc-number">2.2.</span> <span class="toc-text">简单示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#重复提交问题"><span class="toc-number">3.</span> <span class="toc-text">重复提交问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是表单的重复提交？"><span class="toc-number">3.1.</span> <span class="toc-text">什么是表单的重复提交？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决方法"><span class="toc-number">3.2.</span> <span class="toc-text">解决方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义拦截器"><span class="toc-number">4.</span> <span class="toc-text">自定义拦截器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义拦截器实例"><span class="toc-number">4.1.</span> <span class="toc-text">自定义拦截器实例</span></a></li></ol></li></ol>
		</div>
		
		<h2 id="文件上传">文件上传</h2>
<p>文件上传的功能是由<code>FileUploadInterceptor</code>拦截器扩展的，查看这个拦截器的javadoc了解具体的用法。</p>
<h3 id="简单示例">简单示例</h3>
<p>首先，提交 表单需要注意的3点：</p>
<ul>
<li>须把 HTML 表单的 enctype 属性设置为 multipart/form-data；</li>
<li>须把 HTML 表单的method 属性设置为 post；</li>
<li>需添加<code>&lt;input type=&quot;file&quot;&gt;</code>字段。</li>
</ul>
<p>示例：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;s:form action=<span class="string">"testUpload.action"</span> <span class="keyword">method</span>=<span class="string">"post"</span> enctype=<span class="string">"multipart/form-data"</span> theme=<span class="string">"simple"</span>&gt;</div><div class="line">    <span class="type">File</span>:&lt;s:textfield name=<span class="string">"text"</span> <span class="keyword">type</span>=<span class="string">"file"</span>/&gt;&lt;br/&gt;</div><div class="line">    <span class="type">Desc</span>:&lt;s:textfield name=<span class="string">"desc"</span>/&gt;&lt;br/&gt;</div><div class="line">    &lt;s:submit label=<span class="string">"submit"</span>/&gt;</div><div class="line">&lt;/s:form&gt;</div></pre></td></tr></table></figure>

<p>然后Action类中接收<code>&lt;input type=&quot;file&quot;&gt;</code>字段需要3个属性，它们的命名规则为：</p>
<ul>
<li>[File Name] : File - the actual File</li>
<li>[File Name]ContentType : String - the content type of the file</li>
<li>[File Name]FileName : String - the actual name of the file uploaded (not the HTML name)</li>
</ul>
<p>所以这时候的Action类属性为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestUploadAction</span> <span class="keyword">extends</span> <span class="title">ActionSupport</span></span>{</div><div class="line">     <span class="comment">// 3个固定属性</span></div><div class="line">    <span class="keyword">private</span> File text;</div><div class="line">    <span class="keyword">private</span> String textContentType;</div><div class="line">    <span class="keyword">private</span> String textFileName;</div><div class="line">    <span class="comment">// 其它属性</span></div><div class="line"></div><div class="line">    <span class="keyword">private</span> String desc;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// ...... getter、setter方法</span></div><div class="line"></div><div class="line">}</div></pre></td></tr></table></figure>

<p>最后在目标方法中就可以获取<code>File</code>对象的输入流，转换为输出流保存。例如TestUploadAction中：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestUploadAction</span> <span class="keyword">extends</span> <span class="title">ActionSupport</span></span>{</div><div class="line"></div><div class="line">    <span class="comment">// ......</span></div><div class="line"></div><div class="line">     <span class="keyword">public</span> String <span class="title">execute</span>() <span class="keyword">throws</span> Exception {       </div><div class="line">        InputStream is = <span class="keyword">new</span> FileInputStream(text);</div><div class="line"> </div><div class="line">        String path = ServletActionContext.getServletContext().getRealPath(<span class="string">"/files/"</span> + textFileName);</div><div class="line">        OutputStream os = <span class="keyword">new</span> FileOutputStream(path);</div><div class="line"> </div><div class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</div><div class="line">        <span class="keyword">int</span> length = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span>((length = is.read(buffer)) != -<span class="number">1</span>) {</div><div class="line">            os.write(buffer, <span class="number">0</span>, length);</div><div class="line">        }</div><div class="line">        os.close();</div><div class="line">        is.close();  </div><div class="line">        <span class="keyword">return</span> SUCCESS;</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="提交多个文件">提交多个文件</h3>
<p>首先Action类中的属性修改为<code>List</code>集合类型并重写getter、setter方法：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestUploadAction</span> <span class="keyword">extends</span> <span class="title">ActionSupport</span></span>{</div><div class="line">     <span class="comment">// 3个固定属性</span></div><div class="line"></div><div class="line">    <span class="keyword">private</span> List&lt;File&gt; text;</div><div class="line">    <span class="keyword">private</span> List&lt;String&gt; textContentType;</div><div class="line">    <span class="keyword">private</span> List&lt;String&gt; textFileName;</div><div class="line">    <span class="comment">// 其它属性</span></div><div class="line">    <span class="keyword">private</span> List&lt;String&gt; desc;</div></pre></td></tr></table></figure>

<p><strong>提交表单中 <code>&lt;input type=&quot;file&quot;&gt;</code>字段name属性值不能改，其它 字段为了回显正常，需要使数组下标的方式</strong>。例如：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;<span class="symbol">s:</span>form action=<span class="string">"testUpload.action"</span> method=<span class="string">"post"</span> enctype=<span class="string">"multipart/form-data"</span> theme=<span class="string">"simple"</span>&gt; </div><div class="line">    <span class="constant">File</span><span class="symbol">:&lt;s</span><span class="symbol">:textfield</span> name=<span class="string">"text"</span> type=<span class="string">"file"</span>/&gt;&lt;br/&gt;                                           </div><div class="line">    <span class="constant">Desc</span><span class="symbol">:&lt;s</span><span class="symbol">:textfield</span> name=<span class="string">"desc[0]"</span>/&gt;&lt;br/&gt;                                                    </div><div class="line">    &lt;br/&gt;                                                                                      </div><div class="line">    <span class="constant">File</span><span class="symbol">:&lt;s</span><span class="symbol">:textfield</span> name=<span class="string">"text"</span> type=<span class="string">"file"</span>/&gt;&lt;br/&gt;                                           </div><div class="line">    <span class="constant">Desc</span><span class="symbol">:&lt;s</span><span class="symbol">:textfield</span> name=<span class="string">"desc[1]"</span>/&gt;&lt;br/&gt;                                                    </div><div class="line">    &lt;br/&gt;                                                                                      </div><div class="line">    <span class="constant">File</span><span class="symbol">:&lt;s</span><span class="symbol">:textfield</span> name=<span class="string">"text"</span> type=<span class="string">"file"</span>/&gt;&lt;br/&gt;                                           </div><div class="line">    <span class="constant">Desc</span><span class="symbol">:&lt;s</span><span class="symbol">:textfield</span> name=<span class="string">"desc[2]"</span>/&gt;&lt;br/&gt;                                                    </div><div class="line">    &lt;<span class="symbol">s:</span>submit label=<span class="string">"submit"</span>/&gt;                                                                 </div><div class="line">&lt;<span class="regexp">/s:form&gt;</span></div></pre></td></tr></table></figure>

<h3 id="限制上传文件">限制上传文件</h3>
<p>可以对上传文件的大小、扩展名、内容等限制，方法是<strong>修改<code>FileUploadInterceptor</code>拦截器的参数</strong>，因为是由这个拦截器负责文件上传的。修改拦截器属性参数需要在struts.xml文件中重新配置拦截器栈并对相应拦截器的相关属性修改。<br>例如：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;interceptors&gt;</div><div class="line">    &lt;interceptor-stack name=<span class="string">"fileUploadStack"</span>&gt;                                                         </div><div class="line">        &lt;interceptor-<span class="keyword">ref</span> name=<span class="string">"defaultStack"</span>&gt;                                                          </div><div class="line">            &lt;param name=<span class="string">"fileUpload.maximumSize"</span>&gt;<span class="number">2097152</span>&lt;/param&gt;                                       </div><div class="line">            &lt;param name=<span class="string">"fileUpload.allowedTypes"</span>&gt;text/html,text/xml&lt;/param&gt;                           </div><div class="line">            &lt;param name=<span class="string">"fileUpload.allowedExtensions"</span>&gt;html,dtd,xml&lt;/param&gt;                            </div><div class="line">        &lt;/interceptor-<span class="keyword">ref</span>&gt;                                                                             </div><div class="line">    &lt;/interceptor-stack&gt;                                                                               </div><div class="line">&lt;/interceptors&gt;                                                                                        </div><div class="line">&lt;default-interceptor-<span class="keyword">ref</span> name=<span class="string">"fileUploadStack"</span>&gt;&lt;/default-interceptor-<span class="keyword">ref</span>&gt;</div></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li>maximumSize：可选，上传的单个文件的最大值， 默认的最大值为 2M ；</li>
<li>allowedTypes：可选，允许的上传文件的类型，多个使用<code>,</code>分割；</li>
<li>allowedExtensions ：可选，允许的上传文件的扩展名，多个使用<code>,</code>分割；</li>
</ul>
<h3 id="文件上传错误消息处理">文件上传错误消息处理</h3>
<p>文件上传出现错误时，希望显示错误消息。</p>
<p>首先需要配置错误消息的资源文件，和国际化资源文件类似，**可以参考struts2-core-xxx.jar包下的org.apache.struts2.struts-messages.properties文件的内容配置错误消息，例如：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">struts.messages.<span class="keyword">error</span>.uploading=Error uploading: {<span class="number">0</span>}</div><div class="line">struts.messages.<span class="keyword">error</span>.<span class="type">file</span>.too.large=File {<span class="number">0</span>} <span class="keyword">is</span> too large <span class="keyword">to</span> be uploaded. Maximum allowed size <span class="keyword">is</span> {<span class="number">4</span>} bytes!</div><div class="line">struts.messages.<span class="keyword">error</span>.content.type.<span class="keyword">not</span>.allowed=Content-Type <span class="keyword">not</span> allowed: {<span class="number">0</span>} <span class="string">"{1}"</span> <span class="string">"{2}"</span> {<span class="number">3</span>}</div><div class="line">struts.messages.<span class="keyword">error</span>.<span class="type">file</span>.extension.<span class="keyword">not</span>.allowed=File extension <span class="keyword">not</span> allowed: {<span class="number">0</span>} <span class="string">"{1}"</span> <span class="string">"{2}"</span> {<span class="number">3</span>}</div></pre></td></tr></table></figure>

<p>在JSP页面还是可以使用s:fielderror或者EL表达式获取，例如：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">${fieldErrors.text[0]}</span></div></pre></td></tr></table></figure>

<p>注意，文件上传的总大小在Struts的默认配置文件中用<code>struts.multipart.maxSize</code>定义为2M。<strong>如果当多个文件上传时总大小超出了限制，则出现的错误是actionError，也就是需要使用s:actionError标签获取，或者使用EL表达式<code>${actionErrors.filePropertyName[0]}</code>的方式获取。</strong></p>
<h2 id="文件下载">文件下载</h2>
<p>页面直接提供超链接浏览器就能自动下载，为什么Struts2还提供下载功能？ 因为某些文件是需要动态生成的，例如提供一些参数然后从数据库获取数据，生成execle文件供下载。</p>
<h3 id="type=”stream”的result元素">type=”stream”的result元素</h3>
<p>在配置struts.xml文件时，result元素的type属性可以是stream，这是专门为文件下载准备的， 使用这种类型不需要准备JSP页面。</p>
<p>type=”stream”对应的类型为<code>StreamResult</code>，这个类提供了下列的参数：</p>
<ul>
<li>contentType：被下载的文件的 MIME 类型，默认值为 text/plain；</li>
<li>contentLength：被下载的文件的大小，以字节为单位；</li>
<li>contentDisposition： 可以设置下载文件名的ContentDispositon 响应头，默认值为 inline，通常设置为<code>attachment;filename=&quot;document.pdf&quot;</code></li>
<li>inputName：Action中提供的文件的输入流，默认值为 inputStream；</li>
<li>bufferSize：文件下载时缓冲区的大小。默认值为 1024；</li>
<li>allowCaching ：文件下载时是否允许使用缓存。默认值为 true；</li>
<li>contentCharSet：文件下载时的字符编码。</li>
</ul>
<p><strong>注意这些参数可以在<code>&lt;result type=&quot;stream&quot;&gt;</code>文件中设置，也可以在Acton类中设置！</strong>一般前4个在Action中设置，后3个在struts.xml中配置。</p>
<h3 id="简单示例-1">简单示例</h3>
<p>配置struts.xml文件，添加type=”stream”的result元素。例如：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;action name=<span class="string">"testDownload"</span> class=<span class="string">"section10.TestDownloadAction"</span>&gt;   </div><div class="line">    &lt;<span class="literal">result</span> <span class="keyword">type</span>=<span class="string">"stream"</span>&gt;                                          </div><div class="line">        &lt;param name=<span class="string">"bufferSize"</span>&gt;<span class="number">1024</span>&lt;/param&gt;                       </div><div class="line">    &lt;/<span class="literal">result</span>&gt;                                                       </div><div class="line">&lt;/action&gt;</div></pre></td></tr></table></figure>


<p><strong>这里对bufferSize属性进行了修改。</strong></p>
<p>提供Action类并在该类中提供type=stream的参数，例如：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDownloadAction</span> <span class="keyword">extends</span> <span class="title">ActionSupport</span></span>{</div><div class="line">    <span class="comment">// 提供type=stream的参数和getter、setter方法</span></div><div class="line">    <span class="keyword">private</span> String contentType;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> contentLength;</div><div class="line">    <span class="keyword">private</span> String contentDisposition;</div><div class="line">    <span class="keyword">private</span> InputStream inputStream;</div><div class="line">    <span class="comment">// getter、setter</span></div><div class="line"></div><div class="line">}</div></pre></td></tr></table></figure>

<p><strong>这里定义了4个和文件下载密切相关的属性，它们的类型可以参考<code>StreamResult</code>类型中对这些参数的定义。</strong></p>
<p>最后在目标方法中实现下载功能：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDownloadAction</span> <span class="keyword">extends</span> <span class="title">ActionSupport</span></span>{</div><div class="line"></div><div class="line">    <span class="keyword">public</span> String <span class="title">execute</span>() <span class="keyword">throws</span> Exception {</div><div class="line">        String filename = <span class="string">"books.txt"</span>;</div><div class="line">        <span class="comment">// 设置contentType和contentDisposition</span></div><div class="line">        contentType = <span class="string">"text/html"</span>;</div><div class="line">        contentDisposition = <span class="string">"attachment;filename="</span> + filename;</div><div class="line">        <span class="comment">// 设置inputStream</span></div><div class="line">        String path = ServletActionContext.getServletContext().getRealPath(<span class="string">"/files/"</span> + filename);</div><div class="line">        inputStream = <span class="keyword">new</span> FileInputStream(path);</div><div class="line">        <span class="comment">// 设置contentLength</span></div><div class="line">        contentLength = inputStream.available();</div><div class="line">        <span class="keyword">return</span> SUCCESS;</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>在目标方法中修改4个属性，最后下载的时候自动调用属性的getter方法获取。</p>
<h2 id="重复提交问题">重复提交问题</h2>
<h3 id="什么是表单的重复提交？">什么是表单的重复提交？</h3>
<p>在不刷新表单页面的前提下：</p>
<ul>
<li>多次点击提交按钮；</li>
<li>已经提交成功，按浏览器的”回退”之后，再直接提交；</li>
<li>在请求控制器为<strong>转发（即dispatcher）</strong>情况下，若已经提交成功请转发到目标页面，此时 点击”刷新”；<br><strong>注意：这种情况浏览器会提示重复提交，而上面的2种情况则不会提示。</strong></li>
</ul>
<p>下面情况不是重复提交：</p>
<ul>
<li>直接刷新输入表单页面，再提交不算重复提交；</li>
<li>若使用的是<strong>重定向（即redirect）</strong>的响应类型，即使已经提交成功并重定向到目标页面，此时再点击 “刷新”，不是表单的重复提交。</li>
</ul>
<h3 id="解决方法">解决方法</h3>
<p>Struts2提供了一个<code>&lt;s:token/&gt;</code>标签和两个拦截器解决重复提交问题。</p>
<p><strong>它的原理是这样的：</strong><br>当表单中有 <code>&lt;s:token/&gt;</code>标签标签时，JSP经过解析后会生成一个隐藏域，同时把隐藏域字段值保持到HttpSession中。所以提交表单是会比较隐藏域的值和Session中的值是否一致： 若一致，则从Session中异常隐藏域的值并执行后续的拦截器； 若不一致，则返回。</p>
<p>从这里可以知道， <code>&lt;s:token/&gt;</code>标签一定和拦截器搭配使用，Struts中有<strong>token</strong>和<strong>tokenSession</strong>两个拦截器可以选择，它们的区别就是隐藏域和Session中的值不一致的时候返回操作：</p>
<ul>
<li>token：使用token拦截器会转到<strong> invalid.token</strong>这个result，并且设置错误消息到值栈的<strong>actionErrors</strong>中；<blockquote>
<p>可以查看<code>TokenInterceptor</code>的方法<code>handleInvalidToken</code>确定这一点</p>
</blockquote>
</li>
</ul>
<ul>
<li>tokenSession：使用tokenSession拦截器会继续返回目标页面，但是因为后面的拦截器没有执行，所以目标方法也不会执行，这样效果就像什么都没有发生。<blockquote>
<p>查看<code>TokenSessionStoreInterceptor</code>的<code>handleInvalidToken</code>方法发现，该拦截器会把目标方法的resultCode获取（返回结果）</p>
</blockquote>
</li>
</ul>
<p><strong>注意：token和tokenSession都不在默认拦截器栈中，所以需要手动配置</strong>，例如下面配置token拦截器（配置tokenSession类似）：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;action name=<span class="string">"testToken"</span> class=<span class="string">"section10.TestTokenAction"</span>&gt;                             </div><div class="line">    &lt;interceptor-<span class="keyword">ref</span> name=<span class="string">"token"</span>&gt;&lt;/interceptor-<span class="keyword">ref</span>&gt;                             </div><div class="line">    &lt;interceptor-<span class="keyword">ref</span> name=<span class="string">"defaultStack"</span>&gt;&lt;/interceptor-<span class="keyword">ref</span>&gt;                             </div><div class="line">    &lt;<span class="literal">result</span> <span class="keyword">type</span>=<span class="string">"dispatcher"</span>&gt;/<span class="type">WEB</span>-<span class="type">INF</span>/section10/success.jsp&lt;/<span class="literal">result</span>&gt;                   </div><div class="line">    &lt;<span class="literal">result</span> name=<span class="string">"invalid.token"</span>&gt;/<span class="type">WEB</span>-<span class="type">INF</span>/section10/token_valid.jsp&lt;/<span class="literal">result</span>&gt;            </div><div class="line">&lt;/action&gt;</div></pre></td></tr></table></figure>




<p>前面已经说明了token拦截会把错误消息设置到值栈的actionErrors s属性中。因此可以用<code>&lt;s:actionerror/&gt;</code>标签或者EL表达式来显示重复提交的错误消息。<strong> 该错误消息可以在国际化资源文件中覆盖，</strong>并且可以参考struts-messages.properties 文件中的 struts.messages.invalid.token配置项。</p>
<p><strong>最后要注意，这里解决重复提交的方法，并没有把浏览器自动提示重复提交的问题去掉。</strong>例如IE会提示下列的信息：</p>
<blockquote>
<p>若再次显示该网页，web浏览器需要重新发送您以前提交的信息。 如果你正在交易，应单击“取消”避免重复交易。 否则，请单击“重试”再次显示该页面。</p>
</blockquote>
<h2 id="自定义拦截器">自定义拦截器</h2>
<p>Struts的很多功能都是通过拦截器实现的，每个拦截器都实现<code>Interceptor</code>接口，它有3个方法：</p>
<ul>
<li>init：该方法将在拦截器被创建后立即被调用，它在拦截器的生命周期内只被调用一次，<strong>也就是保证拦截器是单例的。</strong></li>
</ul>
<ul>
<li>interecept：每拦截一个请求，该方法就会被调用一次；</li>
</ul>
<ul>
<li>destroy：该方法将在拦截器被销毁之前被调用，它在拦截器的生命周期内也只被调用一次。</li>
</ul>
<p><code>AbstractInterceptor</code>类实现了<code>Interceptor</code>接口，并为<code>init</code>和<code>destroy</code>提供了一个空白的实现。自定义拦截器可以实现这个类型。</p>
<h3 id="自定义拦截器实例">自定义拦截器实例</h3>
<p>首先定义一个拦截器：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyInterceptor</span> <span class="keyword">extends</span> <span class="title">AbstractInterceptor</span></span>{</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1</span>L;</div><div class="line"> </div><div class="line">    <span class="annotation">@Override</span></div><div class="line">    <span class="keyword">public</span> String <span class="title">intercept</span>(ActionInvocation invocation) <span class="keyword">throws</span> Exception {</div><div class="line">        System.out.println(<span class="string">"before MyInterceptor ..."</span>);</div><div class="line">        String result = invocation.invoke();</div><div class="line">        System.out.println(<span class="string">"before MyInterceptor ..."</span>);</div><div class="line">        <span class="comment">// 注意调用invocation的invoke方法，并把结果值作为这里的返回值</span></div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>注意，如果希望继续调用后面的拦截器，则需要调用<code>ActionInvocation</code>的<code>invoke</code>方法并把 结果值 作为当前<code>intercept</code>的 返回值 。</p>
<p>在struts.xml文件中声明拦截器：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;interceptors&gt;                                                                       </div><div class="line">    &lt;interceptor name=<span class="string">"myInterceptor"</span> class=<span class="string">"section10.MyInterceptor"</span>&gt;&lt;/interceptor&gt; </div><div class="line">    &lt;interceptor-stack name=<span class="string">"fileUploadStack"</span>&gt;                                       </div><div class="line">        &lt;interceptor-<span class="keyword">ref</span> name=<span class="string">"defaultStack"</span>&gt;                                        </div><div class="line">            &lt;param name=<span class="string">"fileUpload.maximumSize"</span>&gt;<span class="number">2097152</span>&lt;/param&gt;                     </div><div class="line">            &lt;param name=<span class="string">"fileUpload.allowedTypes"</span>&gt;text/html,text/xml&lt;/param&gt;         </div><div class="line">            &lt;param name=<span class="string">"fileUpload.allowedExtensions"</span>&gt;html,dtd,xml&lt;/param&gt;          </div><div class="line">        &lt;/interceptor-<span class="keyword">ref</span>&gt;                                                           </div><div class="line">    &lt;/interceptor-stack&gt;                                                             </div><div class="line">&lt;/interceptors&gt;</div></pre></td></tr></table></figure>

<p><strong>可以作为interceptors的子标签或者作为interceptor-stack的子标签使用！</strong></p>
<p>使用：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;action name=<span class="string">"xxx"</span> class=<span class="string">"Xxx"</span>&gt;</div><div class="line">    &lt;interceptor-<span class="keyword">ref</span> name=<span class="string">"myInterceptor"</span>/&gt;</div><div class="line">    &lt;interceptor-<span class="keyword">ref</span> name=<span class="string">"defaultStack"</span>/&gt;</div><div class="line">&lt;/action&gt;</div></pre></td></tr></table></figure>

  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/Struts2/">Struts2</a>
  </div>




<div class="article-share" id="share">

  <div data-url="http://yoursite.com/2015/04/27/Java/Struts2/Struts2完全教程（5）- 文件上传下载，表单重复提交和自定义拦截器/" data-title="Struts2完全教程（5）- 文件上传下载，表单重复提交和自定义拦截器 | LC的笔记" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/04/27/Java/设计模式/代理模式/" title="代理模式">
  <strong>PREVIOUS:</strong><br/>
  <span>
  代理模式</span>
</a>
</div>


<div class="next">
<a href="/2015/04/27/Java/Struts2/Struts2完全教程（4）- 类型转换和国际化/"  title="Struts2完全教程（4）- 类型转换和国际化">
 <strong>NEXT:</strong><br/> 
 <span>Struts2完全教程（4）- 类型转换和国际化
</span>
</a>
</div>

</nav>

	
</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#文件上传"><span class="toc-number">1.</span> <span class="toc-text">文件上传</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#简单示例"><span class="toc-number">1.1.</span> <span class="toc-text">简单示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#提交多个文件"><span class="toc-number">1.2.</span> <span class="toc-text">提交多个文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#限制上传文件"><span class="toc-number">1.3.</span> <span class="toc-text">限制上传文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#文件上传错误消息处理"><span class="toc-number">1.4.</span> <span class="toc-text">文件上传错误消息处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#文件下载"><span class="toc-number">2.</span> <span class="toc-text">文件下载</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#type=”stream”的result元素"><span class="toc-number">2.1.</span> <span class="toc-text">type=”stream”的result元素</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#简单示例-1"><span class="toc-number">2.2.</span> <span class="toc-text">简单示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#重复提交问题"><span class="toc-number">3.</span> <span class="toc-text">重复提交问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是表单的重复提交？"><span class="toc-number">3.1.</span> <span class="toc-text">什么是表单的重复提交？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决方法"><span class="toc-number">3.2.</span> <span class="toc-text">解决方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义拦截器"><span class="toc-number">4.</span> <span class="toc-text">自定义拦截器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义拦截器实例"><span class="toc-number">4.1.</span> <span class="toc-text">自定义拦截器实例</span></a></li></ol></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  

  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Android/" title="Android">Android<sup>3</sup></a></li>
		
			<li><a href="/tags/Concurrent/" title="Concurrent">Concurrent<sup>7</sup></a></li>
		
			<li><a href="/tags/ConcurrentAPI/" title="ConcurrentAPI">ConcurrentAPI<sup>1</sup></a></li>
		
			<li><a href="/tags/Cookie-Session/" title="Cookie&amp;Session">Cookie&amp;Session<sup>2</sup></a></li>
		
			<li><a href="/tags/Hibernate/" title="Hibernate">Hibernate<sup>5</sup></a></li>
		
			<li><a href="/tags/JDBC/" title="JDBC">JDBC<sup>3</sup></a></li>
		
			<li><a href="/tags/JSP-Servlet/" title="JSP&amp;Servlet">JSP&amp;Servlet<sup>5</sup></a></li>
		
			<li><a href="/tags/Java/" title="Java">Java<sup>3</sup></a></li>
		
			<li><a href="/tags/Maven/" title="Maven">Maven<sup>4</sup></a></li>
		
			<li><a href="/tags/MyBatis/" title="MyBatis">MyBatis<sup>2</sup></a></li>
		
			<li><a href="/tags/NIO/" title="NIO">NIO<sup>6</sup></a></li>
		
			<li><a href="/tags/Network/" title="Network">Network<sup>2</sup></a></li>
		
			<li><a href="/tags/Oracle/" title="Oracle">Oracle<sup>6</sup></a></li>
		
			<li><a href="/tags/SQL/" title="SQL">SQL<sup>6</sup></a></li>
		
			<li><a href="/tags/Spring/" title="Spring">Spring<sup>5</sup></a></li>
		
			<li><a href="/tags/SpringMVC/" title="SpringMVC">SpringMVC<sup>4</sup></a></li>
		
			<li><a href="/tags/Struts2/" title="Struts2">Struts2<sup>5</sup></a></li>
		
			<li><a href="/tags/设计模式/" title="设计模式">设计模式<sup>12</sup></a></li>
		
		</ul>
</div>


  <div class="rsspart">
	<a href="null" target="_blank" title="rss">RSS</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font clearfix">
		
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2015 
		
		<a href="http://yoursite.com" target="_blank" title="zlc">zlc</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>






  </body>
</html>
