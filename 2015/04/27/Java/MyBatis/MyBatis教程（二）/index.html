
 <!DOCTYPE HTML>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
  
    <title>MyBatis教程（二） | LC的笔记</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="zlc">
    
    <meta name="description" content="CRUD操作
使用SQL映射文件
（1）首先提供一个SQL映射文件内容：
12345678910111213141516171819202122232425262728293031&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&amp;gt;&amp;lt;!DOCTYPE ma">
    
    
    
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="LC的笔记" title="LC的笔记"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="LC的笔记">LC的笔记</a></h1>
				<h2 class="blog-motto">好记性不如烂笔头</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:yoursite.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/04/27/Java/MyBatis/MyBatis教程（二）/" title="MyBatis教程（二）" itemprop="url">MyBatis教程（二）</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://yoursite.com" title="zlc">zlc</a>
    </p>
  <p class="article-time">
    <time datetime="2015-04-27T11:05:15.000Z" itemprop="datePublished">4月 27 2015</time>
    Updated:<time datetime="2015-04-27T11:05:15.000Z" itemprop="dateModified">4月 27 2015</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#CRUD操作"><span class="toc-number">1.</span> <span class="toc-text">CRUD操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用SQL映射文件"><span class="toc-number">1.1.</span> <span class="toc-text">使用SQL映射文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用映射接口"><span class="toc-number">1.2.</span> <span class="toc-text">使用映射接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#同时使用SQL映射文件和映射接口"><span class="toc-number">1.3.</span> <span class="toc-text">同时使用SQL映射文件和映射接口</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常用操作补充"><span class="toc-number">2.</span> <span class="toc-text">常用操作补充</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用独立的数据库配置文件"><span class="toc-number">2.1.</span> <span class="toc-text">使用独立的数据库配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#全类名的别名"><span class="toc-number">2.2.</span> <span class="toc-text">全类名的别名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#日志输出功能"><span class="toc-number">2.3.</span> <span class="toc-text">日志输出功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据库表字段和实体类属性名的映射"><span class="toc-number">2.4.</span> <span class="toc-text">数据库表字段和实体类属性名的映射</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#关联查询"><span class="toc-number">3.</span> <span class="toc-text">关联查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#一对一关联"><span class="toc-number">3.1.</span> <span class="toc-text">一对一关联</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一对多关联查询"><span class="toc-number">3.2.</span> <span class="toc-text">一对多关联查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一对一和一对多关联"><span class="toc-number">3.3.</span> <span class="toc-text">一对一和一对多关联</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模糊查询"><span class="toc-number">4.</span> <span class="toc-text">模糊查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用动态标签"><span class="toc-number">4.1.</span> <span class="toc-text">使用动态标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用\$获取参数值"><span class="toc-number">4.2.</span> <span class="toc-text">使用\$获取参数值</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#调用存储过程"><span class="toc-number">5.</span> <span class="toc-text">调用存储过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#缓存"><span class="toc-number">6.</span> <span class="toc-text">缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#一级缓存"><span class="toc-number">6.1.</span> <span class="toc-text">一级缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#什么时候清除缓存"><span class="toc-number">6.2.</span> <span class="toc-text">什么时候清除缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二级缓存"><span class="toc-number">6.3.</span> <span class="toc-text">二级缓存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MyBatis与Spring集成"><span class="toc-number">7.</span> <span class="toc-text">MyBatis与Spring集成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#配置"><span class="toc-number">7.1.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL语句和映射接口联合使用"><span class="toc-number">7.2.</span> <span class="toc-text">SQL语句和映射接口联合使用</span></a></li></ol></li></ol>
		</div>
		
		<h2 id="CRUD操作">CRUD操作</h2>
<h3 id="使用SQL映射文件">使用SQL映射文件</h3>
<p>（1）首先提供一个SQL映射文件内容：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="pi">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></div><div class="line"><span class="doctype">&lt;!DOCTYPE mapper</span></div><div class="line">  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"</div><div class="line">  "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</div><div class="line"><span class="tag">&lt;<span class="title">mapper</span> <span class="attribute">namespace</span>=<span class="value">"section02.UserMapper"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 查询操作 --&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="title">select</span> <span class="attribute">id</span>=<span class="value">"selectUser"</span> <span class="attribute">resultType</span>=<span class="value">"section01.User"</span> <span class="attribute">parameterType</span>=<span class="value">"int"</span>&gt;</span></div><div class="line">        select * from Users where id = #{id}</div><div class="line">    <span class="tag">&lt;/<span class="title">select</span>&gt;</span></div><div class="line">     </div><div class="line">    <span class="comment">&lt;!-- 查询所有记录操作 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">select</span> <span class="attribute">id</span>=<span class="value">"selectAllUsers"</span> <span class="attribute">resultType</span>=<span class="value">"section01.User"</span>&gt;</span></div><div class="line">        select * from users</div><div class="line">    <span class="tag">&lt;/<span class="title">select</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 插入操作 --&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="title">insert</span> <span class="attribute">id</span>=<span class="value">"insertUser"</span> <span class="attribute">parameterType</span>=<span class="value">"section01.User"</span>&gt;</span></div><div class="line">        insert into users(name, age) values(#{name}, #{age})</div><div class="line">    <span class="tag">&lt;/<span class="title">insert</span>&gt;</span></div><div class="line">     </div><div class="line">    <span class="comment">&lt;!-- 更新操作 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">update</span> <span class="attribute">id</span>=<span class="value">"updateUser"</span> <span class="attribute">parameterType</span>=<span class="value">"section01.User"</span>&gt;</span></div><div class="line">        update users set name=#{name}, age=#{age} where id=#{id}</div><div class="line">    <span class="tag">&lt;/<span class="title">update</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 删除操作 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">delete</span> <span class="attribute">id</span>=<span class="value">"deleteUser"</span> <span class="attribute">parameterType</span>=<span class="value">"int"</span>&gt;</span></div><div class="line">        delete from users where id=#{id}</div><div class="line">    <span class="tag">&lt;/<span class="title">delete</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">mapper</span>&gt;</span></div></pre></td></tr></table></figure>

<p>注意上面的SQL映射文件中的写法：</p>
<ul>
<li>使用parameterType声明参数类型，例如上面的插入语句<code>parameterType=&quot;section01.User&quot;</code>或者 <code>parameterType=&quot;int&quot;</code> 。<br>如果参数类型是JavaBean，则 使用<code>#属性名</code>的方式获取JavaBean的属性。<br><strong>参数类型还可以使用parameterMap声明，但已经MyBatis 3标记为不宜使用。</strong></li>
</ul>
<ul>
<li>使用resultType声明返回值类型，并且MyBatis可以 自动数据库字段到JavaBean的封装过程。</li>
</ul>
<ul>
<li>返回单条记录和返回多条记录时，返回值类型是一致的， 只是在<code>SqlSession</code>中 获取时用<code>selectOne</code>获取单条记录，用<code>selectList</code>获取多条记录。</li>
</ul>
<hr>
<p>（2）前面已经说明了，要获取配置文件中某条SQL，使用的是<code>namespace + id</code>的格式定位唯一的SQL语句。然后调用<code>SqlSession</code>的<code>insert</code>、<code>update</code>、<code>delete</code>、<code>selectOne</code>和<code>selectList</code>等方法完成CRUD操作。</p>
<p>测试代码：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CRUDTest</span> </span>{</div><div class="line">    <span class="javadoc">/**</span></div><div class="line">     * 获取SqlSessionFactory对象。</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SqlSessionFactory <span class="title">getFactory</span>() {</div><div class="line">        String config = <span class="string">"conf.xml"</span>;</div><div class="line">        InputStream is = CRUDTest.class.getClassLoader().getResourceAsStream(config);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SqlSessionFactoryBuilder().build(is);</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="javadoc">/**</span></div><div class="line">     * 插入一条记录。</div><div class="line">     */</div><div class="line">    <span class="annotation">@Test</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInsert</span>() {</div><div class="line">        SqlSession session = getFactory().openSession();</div><div class="line">        String statement = <span class="string">"section02.UserMapper.insertUser"</span>;</div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            <span class="keyword">int</span> updateRow = session.insert(statement, <span class="keyword">new</span> User(-<span class="number">1</span>, <span class="string">"InsertTest"</span>, <span class="number">20</span>));</div><div class="line">            System.out.println(updateRow);</div><div class="line">            session.commit();</div><div class="line">        } <span class="keyword">finally</span> {</div><div class="line">            session.close();</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line"></div><div class="line">    <span class="javadoc">/**</span></div><div class="line">     * 查询一条记录。</div><div class="line">     */</div><div class="line">    <span class="annotation">@Test</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSelectOne</span>() {</div><div class="line">        SqlSession session = getFactory().openSession();</div><div class="line">        String statement = <span class="string">"section02.UserMapper.selectUser"</span>;</div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            User user = session.selectOne(statement, <span class="number">3</span>);</div><div class="line">            System.out.println(user);</div><div class="line">        } <span class="keyword">finally</span> {</div><div class="line">            session.close();</div><div class="line">        }</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="javadoc">/**</span></div><div class="line">     * 查询所有记录。</div><div class="line">     * 注意，实体需要一个无参的构造器，否则异常。</div><div class="line">     */</div><div class="line">    <span class="annotation">@Test</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSelsectList</span>() {</div><div class="line">        SqlSession session = getFactory().openSession();</div><div class="line">        String statement = <span class="string">"section02.UserMapper.selectAllUsers"</span>;</div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            List&lt;User&gt; list = session.selectList(statement);</div><div class="line">            Iterator&lt;User&gt; iter = list.iterator();</div><div class="line">            <span class="keyword">while</span>(iter.hasNext()) {</div><div class="line">                User user = iter.next();</div><div class="line">                System.out.println(user);</div><div class="line">            }</div><div class="line">            session.commit();</div><div class="line">        } <span class="keyword">finally</span> {</div><div class="line">            session.close();</div><div class="line">        }</div><div class="line">    }</div></pre></td></tr></table></figure>

<p>补充需要注意的几点：</p>
<ul>
<li><code>SqlSession</code>需要手动提交<code>session.commit();</code> ，否则无法进行增、删、改操作。</li>
</ul>
<ul>
<li>通过<code>SqlSession</code>的方法表示返回多条记录还是单条记录：<code>selectList</code>返回集合、<code>selectOne</code>返回单个对象。</li>
</ul>
<ul>
<li>最后，使用<code>selectXXX</code>等方法得到实体类时需要该类定义无参构造器。</li>
</ul>
<blockquote>
<p>使用parameterMap声明参数类型：</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- parameterMap测试 --&gt;</span>                                </div><div class="line"><span class="tag">&lt;<span class="title">insert</span> <span class="attribute">id</span>=<span class="value">"insertUser2"</span> <span class="attribute">parameterMap</span>=<span class="value">"pm"</span>&gt;</span>            </div><div class="line">    insert into users(name, age) values(#{name}, #{age})</div><div class="line"><span class="tag">&lt;/<span class="title">insert</span>&gt;</span>                                              </div><div class="line"><span class="tag">&lt;<span class="title">parameterMap</span> <span class="attribute">type</span>=<span class="value">"java.util.Map"</span> <span class="attribute">id</span>=<span class="value">"pm"</span>&gt;</span>            </div><div class="line">    <span class="tag">&lt;<span class="title">parameter</span> <span class="attribute">property</span>=<span class="value">"name"</span> <span class="attribute">javaType</span>=<span class="value">"String"</span>/&gt;</span>     </div><div class="line">    <span class="tag">&lt;<span class="title">parameter</span> <span class="attribute">property</span>=<span class="value">"age"</span> <span class="attribute">javaType</span>=<span class="value">"Integer"</span>/&gt;</span>     </div><div class="line"><span class="tag">&lt;/<span class="title">parameterMap</span>&gt;</span></div></pre></td></tr></table></figure>

<p>此时的测试方法为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="literal">void</span> testParameterMap() {                                  </div><div class="line">    SqlSession session <span class="subst">=</span> getFactory()<span class="built_in">.</span>openSession();              </div><div class="line">    <span class="built_in">String</span> statement <span class="subst">=</span> <span class="string">"section02.UserMapper.insertUser2"</span>;        </div><div class="line">    try {                                                         </div><div class="line">        <span class="built_in">Map</span><span class="subst">&lt;</span><span class="built_in">String</span>, Object<span class="subst">&gt;</span> <span class="built_in">map</span> <span class="subst">=</span> <span class="literal">new</span> HashMap<span class="subst">&lt;&gt;</span>();                </div><div class="line">        <span class="built_in">map</span><span class="built_in">.</span>put(<span class="string">"name"</span>, <span class="string">"ben2"</span>);                                  </div><div class="line">        <span class="built_in">map</span><span class="built_in">.</span>put(<span class="string">"age"</span>, <span class="number">33</span>);                                       </div><div class="line">        int updateRow <span class="subst">=</span> session<span class="built_in">.</span>insert(statement, <span class="built_in">map</span>);           </div><div class="line">        System<span class="built_in">.</span>out<span class="built_in">.</span>println(updateRow);                            </div><div class="line">        session<span class="built_in">.</span>commit();                                         </div><div class="line">    } finally {                                                   </div><div class="line">        session<span class="built_in">.</span>close();                                          </div><div class="line">    }                                                             </div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="使用映射接口">使用映射接口</h3>
<p>把对数据库CRUD操作定义为一个接口中的CRUD方法，并且用注解的方式绑定对应的SQL语句。<br>这种方式对于简单的SQL语句十分方便。</p>
<p>示例：<br>（1）首先提供接口和CRUD方法：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>{</div><div class="line"> </div><div class="line">    <span class="annotation">@Insert</span>(<span class="string">"insert into users(name, age) values(#{name}, #{age})"</span>)</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insertUser</span>(User user);</div><div class="line"> </div><div class="line">    <span class="annotation">@Update</span>(<span class="string">"update users set name=#{name}, age=#{age} where id=#{id}"</span>)</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> <span class="title">updateUser</span>(User user);</div><div class="line"> </div><div class="line">    <span class="annotation">@Delete</span>(<span class="string">"delete from users where id=#{id}"</span>)</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteUser</span>(<span class="keyword">int</span> id);</div><div class="line"> </div><div class="line">    <span class="annotation">@Select</span>(<span class="string">"select * from Users where id = #{id}"</span>)</div><div class="line">    <span class="keyword">public</span> User <span class="title">selectUser</span>(<span class="keyword">int</span> id);</div><div class="line"> </div><div class="line">    <span class="annotation">@Select</span>(<span class="string">"select * from users"</span>)</div><div class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title">selectAllUsers</span>();</div><div class="line">}</div></pre></td></tr></table></figure>

<p>注解中SQL语句的写法和XML配置文件时类似，由于直接用方法表示CRUD操作，所以方法返回值类型可以直接声明，也就是查询多条记录此时返回值为<code>List&lt;T&gt;</code>。</p>
<p>（2）然后把这个接口添加到项目的配置文件中，</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">configuration</span>&gt;</span></div><div class="line"></div><div class="line">    // ……省略</div><div class="line">    <span class="tag">&lt;<span class="title">mappers</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">mapper</span> <span class="attribute">class</span>=<span class="value">"section03.UserMapper"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">mappers</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">configuration</span>&gt;</span></div></pre></td></tr></table></figure>

<p>这样就可以像是要SQL映射文件一样实现CRUD操作了。</p>
<p>（3）使用该接口时，调用<code>SqlSession</code>的<code>getMapper</code>方法返回接口实现类，然后才能调用接口中的方法：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassMapperTest</span> </span>{</div><div class="line">    <span class="javadoc">/**</span></div><div class="line">     * 获取SqlSessionFactory对象。</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SqlSessionFactory <span class="title">getFactory</span>() {</div><div class="line">        String config = <span class="string">"conf.xml"</span>;</div><div class="line">        InputStream is = ClassMapperTest.class.getClassLoader().getResourceAsStream(config);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SqlSessionFactoryBuilder().build(is);</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="javadoc">/**</span></div><div class="line">     * 使用映射接口类的方法插入一条记录。</div><div class="line">     */</div><div class="line">    <span class="annotation">@Test</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInserts</span>() {</div><div class="line">        SqlSession session = getFactory().openSession();</div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            <span class="comment">// 获取UserMapper的实例对象</span></div><div class="line">            UserMapper mapper = session.getMapper(UserMapper.class);</div><div class="line">            <span class="comment">// 插入一条记录</span></div><div class="line">            <span class="keyword">int</span> updateRow = mapper.insertUser(<span class="keyword">new</span> User(-<span class="number">1</span>, <span class="string">"MapperInsert"</span>, <span class="number">232</span>));</div><div class="line">            session.commit();</div><div class="line">            System.out.println(updateRow);</div><div class="line">        } <span class="keyword">finally</span> {</div><div class="line">            session.close();</div><div class="line">        }</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// 其它方法类似</span></div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="同时使用SQL映射文件和映射接口">同时使用SQL映射文件和映射接口</h3>
<p>映射接口中并不使用注解的方式声明SQL语句，SQL语句在映射文件中实现。此时注意2点：</p>
<ul>
<li>namespace必须与映射接口文件（Mapper.class）的全类名一致。</li>
<li>id必须与接口中的方法名一致。</li>
</ul>
<h2 id="常用操作补充">常用操作补充</h2>
<p>下面介绍一些常用的操作，包括：</p>
<ul>
<li>数据库连接信息和MyBatis项目配置信息分别使用独立的文件；</li>
<li>编辑SQL映射文件时，使用类的别名代替全类名；</li>
<li>添加log4j日志输出功能；</li>
<li>解决数据表字段名和对应实体类属性名不一致的问题（<strong>重要</strong>）。</li>
</ul>
<h3 id="使用独立的数据库配置文件">使用独立的数据库配置文件</h3>
<p>使用独立的数据库配置文件，首先需要 用<code>properties</code> 加载配置文件，然后使用类似EL表达式的方式<code>\${}</code>引用配置文件中的配置项。所以最后应该这样：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">configuration</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 数据库连接配置文件 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">properties</span> <span class="attribute">resource</span>=<span class="value">"db.properties"</span>&gt;</span><span class="tag">&lt;/<span class="title">properties</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 配置数据库连接的信息 --&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="title">environments</span> <span class="attribute">default</span>=<span class="value">"development"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">environment</span> <span class="attribute">id</span>=<span class="value">"development"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">transactionManager</span> <span class="attribute">type</span>=<span class="value">"JDBC"</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">dataSource</span> <span class="attribute">type</span>=<span class="value">"POOLED"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"driver"</span> <span class="attribute">value</span>=<span class="value">"${driver}"</span> /&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"url"</span> <span class="attribute">value</span>=<span class="value">"${url}"</span> /&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"username"</span> <span class="attribute">value</span>=<span class="value">"${username}"</span> /&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"password"</span> <span class="attribute">value</span>=<span class="value">"${password}"</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="title">dataSource</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="title">environment</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">environments</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">configuration</span>&gt;</span></div></pre></td></tr></table></figure>

<h3 id="全类名的别名">全类名的别名</h3>
<p>SQL映射文件中经常需要使用实体类的全类名，例如声明结果类型：<code>resultType=&quot;section01.User&quot;</code>，参数类型：<code>parameterType=&quot;section01.User&quot;</code>等等。</p>
<p>但使用全类名太繁琐了，这时候可以在项目配置文件中为这些全类名声明一个别名，例如：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">configuration</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 使用别名 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">typeAliases</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- 定义类型的别名，也就是对全类名设置别名 --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">typeAlias</span> <span class="attribute">type</span>=<span class="value">"test.section01.User"</span> <span class="attribute">alias</span>=<span class="value">"optimizeUser"</span>/&gt;</span></div><div class="line">        ……</div><div class="line">    <span class="tag">&lt;/<span class="title">typeAliases</span>&gt;</span></div><div class="line"></div><div class="line">    ……</div><div class="line"><span class="tag">&lt;/<span class="title">configuration</span>&gt;</span></div></pre></td></tr></table></figure>

<p>这样就可以在SQL映射文件中直接使用<code>optimizeUser</code>代替 <code>test.section01.User</code>。</p>
<p>但这样为每个类声明别名的方式也不友好，因为大项目中实体类太多了。所以还可以直接对某些package下的所有类 自动 进行管理，例如：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">configuration</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 数据库连接配置文件 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">properties</span> <span class="attribute">resource</span>=<span class="value">"db.properties"</span>&gt;</span><span class="tag">&lt;/<span class="title">properties</span>&gt;</span></div><div class="line"> </div><div class="line">    <span class="comment">&lt;!-- 使用别名 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">typeAliases</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- 定义包名的别名，这时候类的简单类名就是别名，例如test.section01.User类的别名就是User --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">package</span> <span class="attribute">name</span>=<span class="value">"section01"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">package</span> <span class="attribute">name</span>=<span class="value">"section04"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">package</span> <span class="attribute">name</span>=<span class="value">"section05"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">package</span> <span class="attribute">name</span>=<span class="value">"section06"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">package</span> <span class="attribute">name</span>=<span class="value">"section07"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">package</span> <span class="attribute">name</span>=<span class="value">"section09"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">typeAliases</span>&gt;</span></div><div class="line">……</div><div class="line"><span class="tag">&lt;/<span class="title">configuration</span>&gt;</span></div></pre></td></tr></table></figure>

<p><strong>这时候系统就把类的简单类名作为它的别名使用。</strong>例如类<code>section04.User</code>的别名就是<code>User</code>。</p>
<h3 id="日志输出功能">日志输出功能</h3>
<p>添加log4j日志文件输出的功能可以查看许多详细的内容。<br>方法是直接添加log4j的jar包：log4j-xxx.jar，然后在项目中添加log4j的配置文件：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">log4j.<span class="variable">rootLogger=</span>DEBUG, Console</div><div class="line"><span class="comment">#Console</span></div><div class="line">log4j.appender.<span class="variable">Console=</span>org.apache.log4j.ConsoleAppender</div><div class="line">log4j.appender.Console.<span class="variable">layout=</span>org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.Console.layout.<span class="variable">ConversionPattern=</span>%d [%t] %-<span class="number">5</span>p [%c] - %m%n</div><div class="line">log4j.logger.java.sql.<span class="variable">ResultSet=</span>INFO</div><div class="line">log4j.logger.org.<span class="variable">apache=</span>INFO</div><div class="line">log4j.logger.java.sql.<span class="variable">Connection=</span>DEBUG</div><div class="line">log4j.logger.java.sql.<span class="variable">Statement=</span>DEBUG</div><div class="line">log4j.logger.java.sql.<span class="variable">PreparedStatement=</span>DEBUG</div></pre></td></tr></table></figure>

<h3 id="数据库表字段和实体类属性名的映射">数据库表字段和实体类属性名的映射</h3>
<p>例如现在数据库中有一个表order，它的字段分别为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="title">order_id</span></div><div class="line">order_no</div><div class="line">order_price</div></pre></td></tr></table></figure>

<p>对应的实体类<code>Order</code>的属性为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> Order {</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line">    <span class="keyword">private</span> String orderNo;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">float</span> price;</div><div class="line">    <span class="comment">// ……</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p><strong>很明显，在查询该表的记录时，返回结果必然使用反射的方法封装实体类，但类属性名和字段名不一致最终会无法实现封装。</strong></p>
<p>这时候有2中解决方法：</p>
<ul>
<li>SQL的SELECT查询语句提供别名。例如这时候的SQL映射文件内容为：</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">mapper</span> <span class="attribute">namespace</span>=<span class="value">"section04.OrderMapper"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 数据库表的字段名和实体类的属性名不一致的问题 --&gt;</span></div><div class="line"> </div><div class="line">    <span class="comment">&lt;!-- 解决方法1：SQL语句提供别名</span></div><div class="line">        order_id -&gt; id;</div><div class="line">        order_no -&gt; orderNo;</div><div class="line">        order_price -&gt; price;</div><div class="line">        由于用了别名查询，所以提供resultType就能自动封装结果实体类。</div><div class="line">    --&gt;</div><div class="line">    <span class="tag">&lt;<span class="title">select</span> <span class="attribute">id</span>=<span class="value">"selectOrder1"</span> <span class="attribute">resultType</span>=<span class="value">"Order"</span> <span class="attribute">parameterType</span>=<span class="value">"int"</span>&gt;</span></div><div class="line">        SELECT order_id AS id, order_no AS orderNo, order_price AS price FROM orders WHERE order_id = #{id}</div><div class="line">    <span class="tag">&lt;/<span class="title">select</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">mapper</span>&gt;</span></div></pre></td></tr></table></figure>

<p>这种方法十分简单。</p>
<ul>
<li>另一种方法是使用<code>resultMap</code>标签定义字段名和属性名之间的映射关系。</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&lt;mapper namespace=<span class="string">"section04.OrderMapper"</span>&gt;</div><div class="line"></div><div class="line">    &lt;!-- 解决方法<span class="number">2</span>：自定义映射方法 resultMap</div><div class="line">         <span class="type">SQL</span>语句中使用*号，所以需要更加resultMap的映射规则进行封装。</div><div class="line">    --&gt;</div><div class="line">    &lt;select id=<span class="string">"selectOrder2"</span> resultMap=<span class="string">"OrderMap"</span> parameterType=<span class="string">"int"</span> &gt;</div><div class="line">        <span class="type">SELECT</span> * <span class="type">FROM</span> orders <span class="type">WHERE</span> order_id = <span class="comment">#{id}</span></div><div class="line">    &lt;/select&gt;</div><div class="line"> </div><div class="line">    &lt;!-- 映射方法，其中：</div><div class="line">        id：用于主键的映射</div><div class="line">        <span class="literal">result</span>：用于其他属性的映射</div><div class="line">        注意，resultMap是以类属性为主进行映射封装，而不是以数据库字段为主。</div><div class="line">        简单的说就是告诉<span class="type">MyBatis</span>封装类对象时，哪个属性用哪个字段的值，这在后面一对多联合查询的时候有助理解。</div><div class="line">     --&gt;</div><div class="line">    &lt;resultMap <span class="keyword">type</span>=<span class="string">"Order"</span> id=<span class="string">"OrderMap"</span>&gt;</div><div class="line">        &lt;id property=<span class="string">"id"</span> column=<span class="string">"order_id"</span>/&gt;</div><div class="line">        &lt;<span class="literal">result</span> property=<span class="string">"orderNo"</span> column=<span class="string">"order_no"</span>/&gt;</div><div class="line">        &lt;<span class="literal">result</span> property=<span class="string">"price"</span> column=<span class="string">"order_price"</span>/&gt;</div><div class="line">    &lt;/resultMap&gt;</div><div class="line">&lt;/mapper&gt;</div></pre></td></tr></table></figure>

<p>这种方法适合映射关系比较复杂的情况。<strong> 其中，resultMap用<code>type=&quot;Order&quot;</code>声明最后映射结果封装的实体类类型。</strong></p>
<p><strong>注意，<code>resultMap</code>是以类属性为主进行映射封装，而不是以数据库字段为主。即<code>property</code>是属性名，而<code>column</code>是对应的列名。 简单的说就是告诉MyBatis封装类对象时，哪个属性用哪个字段的值，这在后面一对多联合查询的时候有助理解。</strong></p>
<h2 id="关联查询">关联查询</h2>
<p>通常情况下，JavaBean的属性类型除了是基本数据类型外，还包括引用类型或者引用类型的集合。这时候需要从多个数据表中查询数据并映射到各个属性中，如果属性是引用类型还需要继续映射。</p>
<h3 id="一对一关联">一对一关联</h3>
<p>假如有2个实体类，它们的属性分别为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> Classes {</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="keyword">private</span> Teacher teacher;</div><div class="line">    <span class="comment">// ......</span></div><div class="line"></div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> Teacher {</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="comment">// ......</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p><strong>所谓一对一关联关系，表现在类中也就是一个JavaBean中包含另一个JavaBean属性。</strong></p>
<p>有2种方法可以实现：<br>方法一：使用多表查询等值连接的方式。此时的SQL映射语句为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">select</span> <span class="attribute">id</span>=<span class="value">"select1"</span> <span class="attribute">parameterType</span>=<span class="value">"int"</span> <span class="attribute">resultMap</span>=<span class="value">"_rm1"</span>&gt;</span>                                                 </div><div class="line">    SELECT c_id, c_name, t_id, t_name FROM class c, teacher t WHERE c.teacher_id = t.t_id AND c.c_id = #{id}</div><div class="line"><span class="tag">&lt;/<span class="title">select</span>&gt;</span>                                                                                                  </div><div class="line"><span class="comment">&lt;!--                                                                                                       </span></div><div class="line">    由于这时候Classes和Teacher中都有相同的字段名，所以这里不能使用别名的方式。                                                           </div><div class="line">    只能使用resultMap声明数据库字段和JavaBean属性直接的映射关系。                                                                </div><div class="line"> --&gt;                                                                                                       </div><div class="line"><span class="tag">&lt;<span class="title">resultMap</span> <span class="attribute">type</span>=<span class="value">"Classes"</span> <span class="attribute">id</span>=<span class="value">"_rm1"</span>&gt;</span>                                                                       </div><div class="line">    <span class="tag">&lt;<span class="title">id</span> <span class="attribute">property</span>=<span class="value">"id"</span> <span class="attribute">column</span>=<span class="value">"c_id"</span>/&gt;</span>                                                                      </div><div class="line">    <span class="tag">&lt;<span class="title">result</span> <span class="attribute">property</span>=<span class="value">"name"</span> <span class="attribute">column</span>=<span class="value">"c_name"</span>/&gt;</span>                                                              </div><div class="line"> </div><div class="line">    <span class="comment">&lt;!-- Classes的teacher属性映射的是Java类Teacher --&gt;</span>                                                             </div><div class="line">    <span class="tag">&lt;<span class="title">association</span> <span class="attribute">property</span>=<span class="value">"teacher"</span> <span class="attribute">javaType</span>=<span class="value">"Teacher"</span>&gt;</span>                                                    </div><div class="line">        <span class="tag">&lt;<span class="title">id</span> <span class="attribute">property</span>=<span class="value">"id"</span> <span class="attribute">column</span>=<span class="value">"t_id"</span>/&gt;</span>                                                                  </div><div class="line">        <span class="tag">&lt;<span class="title">result</span> <span class="attribute">property</span>=<span class="value">"name"</span> <span class="attribute">column</span>=<span class="value">"t_name"</span>/&gt;</span>                                                          </div><div class="line">    <span class="tag">&lt;/<span class="title">association</span>&gt;</span>                                                                                         </div><div class="line"><span class="tag">&lt;/<span class="title">resultMap</span>&gt;</span></div></pre></td></tr></table></figure>

<p>这里的重点是使用resultMap对查询出来的多个字段映射为JavaBean属性，并且属性也是引用类型还需要用association再次进行字段到JavaBean的映射。</p>
<p>方法二：分步查询。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;select <span class="variable">id=</span><span class="string">"select2"</span> <span class="variable">parameterType=</span><span class="string">"int"</span> <span class="variable">resultMap=</span><span class="string">"_rm2"</span>&gt;                         </div><div class="line">    SELECT c_id, c_name FROM class c WHERE c.<span class="variable">c_id =</span> <span class="comment">#{id};                         </span></div><div class="line">&lt;/select&gt;                                                                          </div><div class="line">&lt;select <span class="variable">id=</span><span class="string">"select3"</span> <span class="variable">resultType=</span><span class="string">"Student"</span> <span class="variable">parameterType=</span><span class="string">"int"</span>&gt;                     </div><div class="line">    SELECT s.s_id AS id, s.s_name AS NAME FROM student s WHERE s.<span class="variable">class_id =</span> <span class="comment">#{id}; </span></div><div class="line">&lt;/select&gt;                                                                          </div><div class="line"> </div><div class="line">&lt;resultMap <span class="variable">type=</span><span class="string">"Classes2"</span> <span class="variable">id=</span><span class="string">"_rm2"</span>&gt;                                              </div><div class="line">    &lt;id <span class="variable">property=</span><span class="string">"id"</span> <span class="variable">column=</span><span class="string">"c_id"</span>/&gt;                                              </div><div class="line">    &lt;result <span class="variable">property=</span><span class="string">"name"</span> <span class="variable">column=</span><span class="string">"c_name"</span>/&gt;                                      </div><div class="line">    &lt;!--                                                                           </div><div class="line">        同样需要一个参数，所以使用<span class="variable">column=</span><span class="string">"c_id"</span>声明传递的参数值。                                        </div><div class="line">        经过测试，其实这里使用association也是正确的。                                               </div><div class="line">     --&gt;                                                                           </div><div class="line">    &lt;collection <span class="variable">property=</span><span class="string">"students"</span> <span class="variable">column=</span><span class="string">"c_id"</span> <span class="variable">select=</span><span class="string">"select3"</span>/&gt;               </div><div class="line">&lt;/resultMap&gt;</div></pre></td></tr></table></figure>

<p>第一次查询先获取Classes类型的id和name属性的值，然后第二次查询获取teacher属性的值。由于第二次查询时需要一个参数，所以声明传递teacher_id字段的值。</p>
<h3 id="一对多关联查询">一对多关联查询</h3>
<p>假设现在的JavaBean中除了包含基本类型的属性外，还包含了引用类型的集合属性，例如：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> Classes2 {</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="keyword">private</span> List&lt;Student&gt; students;</div><div class="line">    <span class="comment">// ......</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p><strong>所谓一对多关联关系，表现在类中也就是一个JavaBean中包含另一个JavaBean的集合作为属性。</strong></p>
<p>同样有2种方法：<br>方法一：使用多表查询等值连接的方式。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;select id=<span class="string">"select1"</span> parameterType=<span class="string">"int"</span> resultMap=<span class="string">"_rm1"</span>&gt;                                                 </div><div class="line">    <span class="type">SELECT</span> c_id, c_name, s_id, s_name <span class="type">FROM</span> class c, student s <span class="type">WHERE</span> c.c_id = s.class_id <span class="type">AND</span> c.c_id = <span class="comment">#{id};</span></div><div class="line">&lt;/select&gt;                                                                                                  </div><div class="line">&lt;resultMap <span class="keyword">type</span>=<span class="string">"Classes2"</span> id=<span class="string">"_rm1"</span>&gt;                                                                      </div><div class="line">    &lt;id property=<span class="string">"id"</span> column=<span class="string">"c_id"</span>/&gt;                                                                      </div><div class="line">    &lt;<span class="literal">result</span> property=<span class="string">"name"</span> column=<span class="string">"c_name"</span>/&gt;                                                              </div><div class="line">    &lt;!-- <span class="type">Classes2</span>的students属性是<span class="type">List</span>&lt;<span class="type">Student</span>&gt;类型，需要用ofType声明<span class="type">List</span>集合中的泛型为<span class="type">Student</span>--&gt;                              </div><div class="line">    &lt;collection property=<span class="string">"students"</span> ofType=<span class="string">"Student"</span>&gt;                                                      </div><div class="line">        &lt;id property=<span class="string">"id"</span> column=<span class="string">"s_id"</span>/&gt;                                                                  </div><div class="line">        &lt;<span class="literal">result</span> property=<span class="string">"name"</span> column=<span class="string">"s_name"</span>/&gt;                                                          </div><div class="line">    &lt;/collection&gt;                                                                                          </div><div class="line">&lt;/resultMap&gt;</div></pre></td></tr></table></figure>


<p><strong>注意，此时使用的是collection节点声明集合类型的属性，并且用ofType声明集合元素的泛型，其余类似association。</strong></p>
<p>方法二：分步查询。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;select <span class="variable">id=</span><span class="string">"select2"</span> <span class="variable">parameterType=</span><span class="string">"int"</span> <span class="variable">resultMap=</span><span class="string">"_rm2"</span>&gt;                             </div><div class="line">    SELECT c_id, c_name FROM class c WHERE c.<span class="variable">c_id =</span> <span class="comment">#{id};                             </span></div><div class="line">&lt;/select&gt;                                                                              </div><div class="line">&lt;select <span class="variable">id=</span><span class="string">"select3"</span> <span class="variable">resultType=</span><span class="string">"Student"</span> <span class="variable">parameterType=</span><span class="string">"int"</span>&gt;                         </div><div class="line">    SELECT s.s_id AS id, s.s_name AS NAME FROM student s WHERE s.<span class="variable">class_id =</span> <span class="comment">#{id};     </span></div><div class="line">&lt;/select&gt;                                                                              </div><div class="line"> </div><div class="line">&lt;resultMap <span class="variable">type=</span><span class="string">"Classes2"</span> <span class="variable">id=</span><span class="string">"_rm2"</span>&gt;                                                  </div><div class="line">    &lt;id <span class="variable">property=</span><span class="string">"id"</span> <span class="variable">column=</span><span class="string">"c_id"</span>/&gt;                                                  </div><div class="line">    &lt;result <span class="variable">property=</span><span class="string">"name"</span> <span class="variable">column=</span><span class="string">"c_name"</span>/&gt;                                          </div><div class="line">    &lt;!--                                                                               </div><div class="line">        同样需要一个参数，所以使用<span class="variable">column=</span><span class="string">"c_id"</span>声明传递的参数值。                                            </div><div class="line">        经过测试，其实这里使用association也是正确的。                                                   </div><div class="line">     --&gt;                                                                               </div><div class="line">    &lt;collection <span class="variable">property=</span><span class="string">"students"</span> <span class="variable">column=</span><span class="string">"c_id"</span> <span class="variable">select=</span><span class="string">"select3"</span>/&gt;                   </div><div class="line">&lt;/resultMap&gt;</div></pre></td></tr></table></figure>

<p><strong>这时候和一对一关联查询基本一致，而且也可以直接把collection节点改为association，但方法一中则不能这样。</strong></p>
<h3 id="一对一和一对多关联">一对一和一对多关联</h3>
<p>如果JavaBean中既有一对一属性也有一对多的属性，则直接两种属性的查询方法一起使用就行。</p>
<p>例如此时的JavaBean为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> Classes3 {</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="comment">// 一对一关联</span></div><div class="line">    <span class="keyword">private</span> Teacher teacher;</div><div class="line">    <span class="comment">// 一对多关联</span></div><div class="line">    <span class="keyword">private</span> List&lt;Student&gt; students;</div><div class="line">    <span class="comment">// ......</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>方法一：多表等值查询。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">select</span> <span class="attribute">id</span>=<span class="value">"select1"</span> <span class="attribute">parameterType</span>=<span class="value">"int"</span> <span class="attribute">resultMap</span>=<span class="value">"_rm1"</span>&gt;</span>     </div><div class="line">    SELECT c_id, c_name, t.t_id, t.t_name, s_id, s_name        </div><div class="line">    FROM class c, teacher t, student s                         </div><div class="line">    WHERE c.c_id = s.class_id                                  </div><div class="line">    AND t.t_id = c.teacher_id                                  </div><div class="line">    AND c.c_id = 1 ;                                           </div><div class="line"><span class="tag">&lt;/<span class="title">select</span>&gt;</span>                                                      </div><div class="line"><span class="tag">&lt;<span class="title">resultMap</span> <span class="attribute">type</span>=<span class="value">"Classes3"</span> <span class="attribute">id</span>=<span class="value">"_rm1"</span>&gt;</span>                          </div><div class="line">    <span class="tag">&lt;<span class="title">id</span> <span class="attribute">property</span>=<span class="value">"id"</span> <span class="attribute">column</span>=<span class="value">"c_id"</span>/&gt;</span>                          </div><div class="line">    <span class="tag">&lt;<span class="title">result</span> <span class="attribute">property</span>=<span class="value">"name"</span> <span class="attribute">column</span>=<span class="value">"c_name"</span>/&gt;</span>                  </div><div class="line">    <span class="comment">&lt;!-- 一对一关联映射 --&gt;</span>                                           </div><div class="line">    <span class="tag">&lt;<span class="title">association</span> <span class="attribute">property</span>=<span class="value">"teacher"</span> <span class="attribute">javaType</span>=<span class="value">"Teacher"</span>&gt;</span>        </div><div class="line">        <span class="tag">&lt;<span class="title">id</span> <span class="attribute">property</span>=<span class="value">"id"</span> <span class="attribute">column</span>=<span class="value">"t_id"</span>/&gt;</span>                      </div><div class="line">        <span class="tag">&lt;<span class="title">result</span> <span class="attribute">property</span>=<span class="value">"name"</span> <span class="attribute">column</span>=<span class="value">"t_name"</span>/&gt;</span>              </div><div class="line">    <span class="tag">&lt;/<span class="title">association</span>&gt;</span>                                             </div><div class="line">    <span class="comment">&lt;!-- 一对多关联映射 --&gt;</span>                                           </div><div class="line">    <span class="tag">&lt;<span class="title">collection</span> <span class="attribute">property</span>=<span class="value">"students"</span> <span class="attribute">ofType</span>=<span class="value">"Student"</span>&gt;</span>          </div><div class="line">        <span class="tag">&lt;<span class="title">id</span> <span class="attribute">property</span>=<span class="value">"id"</span> <span class="attribute">column</span>=<span class="value">"s_id"</span>/&gt;</span>                      </div><div class="line">        <span class="tag">&lt;<span class="title">result</span> <span class="attribute">property</span>=<span class="value">"name"</span> <span class="attribute">column</span>=<span class="value">"s_name"</span>/&gt;</span>              </div><div class="line">    <span class="tag">&lt;/<span class="title">collection</span>&gt;</span>                                              </div><div class="line"><span class="tag">&lt;/<span class="title">resultMap</span>&gt;</span></div></pre></td></tr></table></figure>

<p>方法二：分步查询。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">select</span> <span class="attribute">id</span>=<span class="value">"select2"</span> <span class="attribute">parameterType</span>=<span class="value">"int"</span> <span class="attribute">resultMap</span>=<span class="value">"_rm2"</span>&gt;</span>                   </div><div class="line">    SELECT c_id, c_name FROM class c WHERE c_id = #{id};                     </div><div class="line"><span class="tag">&lt;/<span class="title">select</span>&gt;</span>                                                                    </div><div class="line"><span class="tag">&lt;<span class="title">select</span> <span class="attribute">id</span>=<span class="value">"select3"</span> <span class="attribute">resultType</span>=<span class="value">"Teacher"</span> <span class="attribute">parameterType</span>=<span class="value">"int"</span>&gt;</span>               </div><div class="line">    SELECT t_id, t_name FROM teacher t WHERE t_id = #{id};                   </div><div class="line"><span class="tag">&lt;/<span class="title">select</span>&gt;</span>                                                                    </div><div class="line"><span class="tag">&lt;<span class="title">select</span> <span class="attribute">id</span>=<span class="value">"select4"</span> <span class="attribute">resultType</span>=<span class="value">"Student"</span> <span class="attribute">parameterType</span>=<span class="value">"int"</span>&gt;</span>               </div><div class="line">    SELECT s_id AS id, s_name AS NAME FROM student s WHERE class_id = #{id}; </div><div class="line"><span class="tag">&lt;/<span class="title">select</span>&gt;</span>                                                                    </div><div class="line"> </div><div class="line"><span class="tag">&lt;<span class="title">resultMap</span> <span class="attribute">type</span>=<span class="value">"Classes3"</span> <span class="attribute">id</span>=<span class="value">"_rm2"</span>&gt;</span>                                        </div><div class="line">    <span class="tag">&lt;<span class="title">id</span> <span class="attribute">property</span>=<span class="value">"id"</span> <span class="attribute">column</span>=<span class="value">"c_id"</span>/&gt;</span>                                        </div><div class="line">    <span class="tag">&lt;<span class="title">result</span> <span class="attribute">property</span>=<span class="value">"name"</span> <span class="attribute">column</span>=<span class="value">"c_name"</span>/&gt;</span>                                </div><div class="line">    <span class="comment">&lt;!-- 一对一关联映射 --&gt;</span>                                                         </div><div class="line">    <span class="tag">&lt;<span class="title">association</span> <span class="attribute">property</span>=<span class="value">"teacher"</span> <span class="attribute">column</span>=<span class="value">"t_id"</span> <span class="attribute">select</span>=<span class="value">"select3"</span>/&gt;</span>         </div><div class="line">    <span class="comment">&lt;!-- 一对多关联映射 --&gt;</span>                                                         </div><div class="line">    <span class="tag">&lt;<span class="title">collection</span> <span class="attribute">property</span>=<span class="value">"students"</span> <span class="attribute">column</span>=<span class="value">"c_id"</span> <span class="attribute">select</span>=<span class="value">"select4"</span>/&gt;</span>         </div><div class="line"><span class="tag">&lt;/<span class="title">resultMap</span>&gt;</span></div></pre></td></tr></table></figure>

<h2 id="模糊查询">模糊查询</h2>
<p>需求：实现SQL语句中like的功能。例如查询语句为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="operator"><span class="keyword">SELECT</span> *  <span class="keyword">FROM</span> users u</span></div><div class="line"><span class="keyword">WHERE</span> u.name <span class="keyword">LIKE</span> <span class="built_in">BINARY</span> <span class="string">'%T%'</span></div><div class="line">  <span class="keyword">AND</span> u.age <span class="keyword">BETWEEN</span> <span class="number">10</span></div><div class="line">  <span class="keyword">AND</span> <span class="number">30</span>;</div></pre></td></tr></table></figure>

<h3 id="使用动态标签">使用动态标签</h3>
<p>MyBatis 中可用的动态 SQL 标签：</p>
<ul>
<li>if</li>
<li>choose(when, otherwise)</li>
<li>trim(where, set)</li>
<li>foreach</li>
</ul>
<p>使用动态标签可以对参数值进行判断。</p>
<p><strong>因为模糊查询中一般会用到<code>%</code>或者<code>_</code>符号，所以判断参数值是否带特殊符号就出现不同情况。</strong></p>
<p>例如SQL映射语句为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 把%符号放到参数值中传递过来。 --&gt;</span>       </div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="title">select</span> <span class="attribute">id</span>=<span class="value">"select1"</span> <span class="attribute">parameterType</span>=<span class="value">"ConditionType"</span> <span class="attribute">resultType</span>=<span class="value">"User"</span>&gt;</span>  </div><div class="line">    SELECT * FROM users u WHERE                                        </div><div class="line">    u.age BETWEEN #{minAge} AND #{maxAge}                              </div><div class="line">    <span class="comment">&lt;!-- 当name为空的时候，传递的值为%null% --&gt;</span>                                    </div><div class="line">    <span class="tag">&lt;<span class="title">if</span> <span class="attribute">test</span>=<span class="value">'name != "%null%"'</span>&gt;</span>                                       </div><div class="line">        AND u.name LIKE BINARY #{name};                                </div><div class="line">    <span class="tag">&lt;/<span class="title">if</span>&gt;</span>                                                              </div><div class="line"><span class="tag">&lt;/<span class="title">select</span>&gt;</span></div></pre></td></tr></table></figure>

<p>此时的测试方法必须为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSelectUser1</span>() {                                                                       </div><div class="line">    SqlSession session = getFactory().openSession();                                                  </div><div class="line">    String statement = <span class="string">"section07.UserMapper.select1"</span>;                                                </div><div class="line">    <span class="keyword">try</span> {                                                                                             </div><div class="line">        String name = <span class="string">"I"</span>;                                                                            </div><div class="line">        name = <span class="keyword">null</span>;                                                                                  </div><div class="line">        <span class="comment">// 注意，当name为null时，则传递的值为%null%。                                                               </span></div><div class="line">        List&lt;User&gt; user = session.selectList(statement,                                               </div><div class="line">                <span class="keyword">new</span> ConditionType(<span class="keyword">new</span> StringBuffer(<span class="string">"%"</span>).append(name).append(<span class="string">"%"</span>).toString(), <span class="number">20</span>, <span class="number">21</span>));                                                                                           </div><div class="line">        session.commit();                                                                             </div><div class="line">    } <span class="keyword">finally</span> {                                                                                       </div><div class="line">        session.close();                                                                              </div><div class="line">    }                                                                                                 </div><div class="line">}</div></pre></td></tr></table></figure>


<p><strong>这是因为当<code>name=null</code>的时候，<code>new StringBuffer(&quot;%&quot;).append(name).append(&quot;%&quot;)</code>的值为<code>%null%</code>！</strong></p>
<p>当然，也可以不传递特殊符号：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 参数值不包含%符号。 --&gt;</span>                                                  </div><div class="line"><span class="tag">&lt;<span class="title">select</span> <span class="attribute">id</span>=<span class="value">"select2"</span> <span class="attribute">parameterType</span>=<span class="value">"ConditionType"</span> <span class="attribute">resultType</span>=<span class="value">"User"</span>&gt;</span></div><div class="line">    SELECT * FROM users u WHERE                                      </div><div class="line">    u.age BETWEEN #{minAge} AND #{maxAge}                            </div><div class="line">    <span class="tag">&lt;<span class="title">if</span> <span class="attribute">test</span>=<span class="value">'name != null'</span>&gt;</span>                                         </div><div class="line">        AND u.name LIKE BINARY CONCAT(CONCAT('%', #{name}), '%');    </div><div class="line">    <span class="tag">&lt;/<span class="title">if</span>&gt;</span>                                                            </div><div class="line"><span class="tag">&lt;/<span class="title">select</span>&gt;</span></div></pre></td></tr></table></figure>

<p>这时候测试方法为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@Test</span>                                                                                     </div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSelectUser2</span>() {                                                           </div><div class="line">    SqlSession session = getFactory().openSession();                                      </div><div class="line">    String statement = <span class="string">"section07.UserMapper.select2"</span>;                                    </div><div class="line">    <span class="keyword">try</span> {                                                                                 </div><div class="line">        String name = <span class="string">"I"</span>;                                                                </div><div class="line">        name = <span class="keyword">null</span>;                                                                      </div><div class="line">        List&lt;User&gt; user = session.selectList(statement, <span class="keyword">new</span> ConditionType(name, <span class="number">20</span>, <span class="number">21</span>));                                                                      </div><div class="line">        session.commit();                                                                 </div><div class="line">    } <span class="keyword">finally</span> {                                                                           </div><div class="line">        session.close();                                                                  </div><div class="line">    }                                                                                     </div><div class="line">}</div></pre></td></tr></table></figure>





<h3 id="使用\$获取参数值">使用<code>\$</code>获取参数值</h3>
<p>在前面的SQL语句中一直都是使用<code>#</code>获取参数类型中的参数值，模糊查询的时候可以使用<code>\$</code>代替：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;<span class="keyword">select</span> id=<span class="string">"select3"</span> parameterType=<span class="string">"ConditionType"</span> resultType=<span class="string">"User"</span>&gt;</div><div class="line">    <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> users u <span class="keyword">WHERE</span>                                     </div><div class="line">    u.name <span class="keyword">LIKE</span> <span class="keyword">BINARY</span> <span class="comment">'%${name}%' AND                              </span></div><div class="line">    u.age BETWEEN <span class="preprocessor">#{minAge} AND #{maxAge}                           </span></div><div class="line">&lt;/<span class="keyword">select</span>&gt;</div></pre></td></tr></table></figure>


<p><strong>同样这时候传递的参数值也不需要带<code>%</code>或者<code>_</code>符号。</strong></p>
<p>测试方法：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSelectUser3</span>() {                                                             </div><div class="line">    SqlSession session = getFactory().openSession();                                        </div><div class="line">    String statement = <span class="string">"section07.UserMapper.select3"</span>;                                      </div><div class="line">    <span class="keyword">try</span> {                                                                                   </div><div class="line">        String name = <span class="string">"I"</span>;                                                                  </div><div class="line">        name = <span class="keyword">null</span>;                                                                        </div><div class="line">        List&lt;User&gt; user = session.selectList(statement, <span class="keyword">new</span> ConditionType(name, <span class="number">20</span>, <span class="number">29</span>));                                                              </div><div class="line">        session.commit();                                                                   </div><div class="line">    } <span class="keyword">finally</span> {                                                                             </div><div class="line">        session.close();                                                                    </div><div class="line">    }                                                                                       </div><div class="line">}</div></pre></td></tr></table></figure>






<h2 id="调用存储过程">调用存储过程</h2>
<p>调用存储过程一般需要传递参数，而且参数又分为输入参数和输出参数，所以这时候需要用parameterMap声明是输入参数还是输出参数。<br>例如对于存储过程：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">DELIMITER $$</div><div class="line"></div><div class="line"></div><div class="line"><span class="operator"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`get_user_count_by_age`</span>$$</span></div><div class="line"> </div><div class="line"><span class="keyword">CREATE</span> DEFINER=<span class="string">`root`</span>@<span class="string">`localhost`</span> <span class="keyword">PROCEDURE</span> <span class="string">`get_user_count_by_age`</span>(<span class="keyword">IN</span> user_age <span class="built_in">INT</span>, OUT user_count <span class="built_in">INT</span>)</div><div class="line"><span class="keyword">BEGIN</span></div><div class="line">    <span class="keyword">IF</span> user_age &gt;= <span class="number">0</span> <span class="keyword">THEN</span></div><div class="line">    <span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(u.id) <span class="keyword">FROM</span> mybatis.users u <span class="keyword">WHERE</span> u.age &gt;= user_age <span class="keyword">INTO</span> user_count;</div><div class="line">    ELSE</div><div class="line">        <span class="operator"><span class="keyword">SELECT</span> <span class="number">0</span> <span class="keyword">INTO</span> user_count;</span></div><div class="line">    <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></div><div class="line"><span class="operator"><span class="keyword">END</span>$$</span></div><div class="line"> </div><div class="line">DELIMITER ;</div></pre></td></tr></table></figure>

<p>定义SQL映射语句为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">select</span> <span class="attribute">id</span>=<span class="value">"callProcedure"</span> <span class="attribute">statementType</span>=<span class="value">"CALLABLE"</span> <span class="attribute">parameterMap</span>=<span class="value">"callProcedureMap"</span>&gt;</span></div><div class="line">    CALL mybatis.get_user_count_by_age(?, ?);                                       </div><div class="line"><span class="tag">&lt;/<span class="title">select</span>&gt;</span>                                                                           </div><div class="line"><span class="comment">&lt;!-- jdbcType：仅仅对插入、更新和删除操作时可能为空的列进行处理。--&gt;</span>                                          </div><div class="line"><span class="tag">&lt;<span class="title">parameterMap</span> <span class="attribute">type</span>=<span class="value">"java.util.HashMap"</span> <span class="attribute">id</span>=<span class="value">"callProcedureMap"</span>&gt;</span>                       </div><div class="line">    <span class="tag">&lt;<span class="title">parameter</span> <span class="attribute">property</span>=<span class="value">"user_age"</span> <span class="attribute">jdbcType</span>=<span class="value">"INTEGER"</span> <span class="attribute">mode</span>=<span class="value">"IN"</span>/&gt;</span>                   </div><div class="line">    <span class="tag">&lt;<span class="title">parameter</span> <span class="attribute">property</span>=<span class="value">"user_count"</span> <span class="attribute">jdbcType</span>=<span class="value">"INTEGER"</span> <span class="attribute">mode</span>=<span class="value">"OUT"</span>/&gt;</span>                </div><div class="line"><span class="tag">&lt;/<span class="title">parameterMap</span>&gt;</span></div></pre></td></tr></table></figure>

<p>注意：</p>
<ul>
<li><code>statementType=&quot;CALLABLE&quot;</code>声明这是存储过程而不是一般查询语句；</li>
<li>mode有IN、OUT和INOUT三个选项。</li>
</ul>
<p>测试方法：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testProcedure</span>() {                                          </div><div class="line">    SqlSession session = getFactory().openSession();                   </div><div class="line">    String statement = <span class="string">"section08.ProcedureMapper.callProcedure"</span>;      </div><div class="line">    <span class="keyword">try</span> {                                                              </div><div class="line">        Map&lt;String, Integer&gt; pm = <span class="keyword">new</span> HashMap&lt;String, Integer&gt;();      </div><div class="line">        pm.put(<span class="string">"user_age"</span>, <span class="number">25</span>);                                        </div><div class="line">        pm.put(<span class="string">"user_count"</span>, -<span class="number">1</span>);                                      </div><div class="line">        System.<span class="keyword">out</span>.println(pm.<span class="keyword">get</span>(<span class="string">"user_count"</span>));                      </div><div class="line">        <span class="comment">// 返回值为null                                                    </span></div><div class="line">        session.selectOne(statement, pm);                              </div><div class="line">        System.<span class="keyword">out</span>.println(pm.<span class="keyword">get</span>(<span class="string">"user_count"</span>));                      </div><div class="line">        session.commit();                                              </div><div class="line">    } <span class="keyword">finally</span> {                                                        </div><div class="line">        session.close();                                               </div><div class="line">    }                                                                  </div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="缓存">缓存</h2>
<h3 id="一级缓存">一级缓存</h3>
<p>一级缓存：基于<code>PerpetualCache</code>的 HashMap 本地缓存，其存储作用域为Session。 默认开启。</p>
<p>示例：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFirstCache1</span>() {                                   </div><div class="line">    SqlSession session = getFactory().openSession();              </div><div class="line">    String statement = <span class="string">"section09.FirstCacheMapper.selectUser"</span>;   </div><div class="line">    <span class="keyword">try</span> {                                                         </div><div class="line">        <span class="comment">// 测试结果：user1和user2都是同一个SqlSession中查询得到的。                 </span></div><div class="line">        User user1 = session.selectOne(statement, <span class="number">2</span>);             </div><div class="line">        System.<span class="keyword">out</span>.println(user1);                                </div><div class="line"> </div><div class="line">        User user2 = session.selectOne(statement, <span class="number">2</span>);             </div><div class="line">        System.<span class="keyword">out</span>.println(user2);                                </div><div class="line">        session.commit();                                         </div><div class="line">    } <span class="keyword">finally</span> {                                                   </div><div class="line">        session.close();                                          </div><div class="line">    }                                                             </div><div class="line">}</div></pre></td></tr></table></figure>

<p><strong>第一次查询时，会把查询结果存放在HashMap中，并把statement和参数组成索引用的key值。第二次查询时候key一致，就会直接从缓存中取出结果。</strong></p>
<p>相关源码：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// BaseExecutor query</span></div><div class="line"><span class="keyword">public</span> &lt;E&gt; <span class="keyword">List</span>&lt;E&gt; query(MappedStatement ms, Object parameter, RowBounds rowBounds,           </div><div class="line">    ResultHandler resultHandler, CacheKey key, BoundSql boundSql) throws SQLException {       </div><div class="line">    <span class="comment">// ......                                                                                 </span></div><div class="line">    <span class="keyword">List</span>&lt;E&gt; <span class="keyword">list</span>;                                                                             </div><div class="line">    <span class="keyword">try</span> {                                                                                     </div><div class="line">        <span class="comment">// 从localCache中查询是否有缓存值                                                                     </span></div><div class="line">        <span class="keyword">list</span> = resultHandler == <span class="keyword">null</span> ? (<span class="keyword">List</span>&lt;E&gt;) localCache.getObject(key) : <span class="keyword">null</span>;            </div><div class="line">        <span class="keyword">if</span> (<span class="keyword">list</span> != <span class="keyword">null</span>) {                               </div><div class="line">            <span class="comment">// 若有则返回缓存值                                     </span></div><div class="line">            handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);                </div><div class="line">        } <span class="keyword">else</span> {                        </div><div class="line">            <span class="comment">// 否则需要从数据库中查询                                                       </span></div><div class="line">            <span class="keyword">list</span> = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql); </div><div class="line">        }                                                                                     </div><div class="line">    }                                                                                          </div><div class="line">    <span class="comment">// ......                                                                                 </span></div><div class="line">}</div></pre></td></tr></table></figure>




<h3 id="什么时候清除缓存">什么时候清除缓存</h3>
<p>在下列3种情况下，缓存会被清除：</p>
<ul>
<li>调用 <code>SqlSession</code>的<code>clearcache</code>或者<code>close</code>方法；<br>示例：</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFirstCacheClear1</span>() {                             </div><div class="line">    SqlSession session = getFactory().openSession();             </div><div class="line">    String statement = <span class="string">"section09.FirstCacheMapper.selectUser"</span>;  </div><div class="line">    <span class="keyword">try</span> {                                                        </div><div class="line">        User user1 = session.selectOne(statement, <span class="number">2</span>);            </div><div class="line">        System.<span class="keyword">out</span>.println(user1);                               </div><div class="line"> </div><div class="line">        <span class="comment">// 清空当前SqlSession的内容                                     </span></div><div class="line">        session.clearCache();                                    </div><div class="line"> </div><div class="line">        User user2 = session.selectOne(statement, <span class="number">2</span>);            </div><div class="line">        System.<span class="keyword">out</span>.println(user2);                               </div><div class="line"> </div><div class="line">        session.commit();                                        </div><div class="line">    } <span class="keyword">finally</span> {                                                  </div><div class="line">        session.close();                                         </div><div class="line">    }                                                            </div><div class="line">}</div></pre></td></tr></table></figure>

<ul>
<li>重新获取<code>SqlSession</code>实例对象；</li>
</ul>
<p>示例：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFirstCacheClear2</span>() {                            </div><div class="line">    SqlSession session = getFactory().openSession();            </div><div class="line">    String statement = <span class="string">"section09.FirstCacheMapper.selectUser"</span>; </div><div class="line">    <span class="keyword">try</span> {                                                       </div><div class="line">        User user1 = session.selectOne(statement, <span class="number">2</span>);           </div><div class="line">        System.<span class="keyword">out</span>.println(user1);                              </div><div class="line">        session.close();                                        </div><div class="line"> </div><div class="line">        <span class="comment">// 重新获取SqlSession，此时并不是同一个SqlSession对象                  </span></div><div class="line">        session = getFactory().openSession();                   </div><div class="line">        User user2 = session.selectOne(statement, <span class="number">2</span>);           </div><div class="line">        System.<span class="keyword">out</span>.println(user2);                              </div><div class="line"> </div><div class="line">        session.commit();                                       </div><div class="line">    } <span class="keyword">finally</span> {                                                 </div><div class="line">        session.close();                                        </div><div class="line">    }                                                           </div><div class="line">}</div></pre></td></tr></table></figure>

<ul>
<li>对当前SqlSession执行增、删、改操作时，都会清空缓存，而且一级和二级缓存都会清除。<br>示例：</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFirstCacheClear3</span>() {                                      </div><div class="line">    SqlSession session = getFactory().openSession();                      </div><div class="line">    String statement = <span class="string">"section09.FirstCacheMapper.selectUser"</span>;           </div><div class="line">    String updateStatement = <span class="string">"section09.FirstCacheMapper.updateUser"</span>;     </div><div class="line">    <span class="keyword">try</span> {                                                                 </div><div class="line">        User user1 = session.selectOne(statement, <span class="number">2</span>);                     </div><div class="line">        System.<span class="keyword">out</span>.println(user1);                                        </div><div class="line"> </div><div class="line">        <span class="comment">// 对当前SqlSession执行增、删、改操作时，都会清空缓存。                                </span></div><div class="line">        session.update(updateStatement, <span class="keyword">new</span> User(<span class="number">2</span>, <span class="string">"CacheUpdate"</span>, <span class="number">33</span>));  </div><div class="line"> </div><div class="line">        User user2 = session.selectOne(statement, <span class="number">2</span>);                     </div><div class="line">        System.<span class="keyword">out</span>.println(user2);                                        </div><div class="line"> </div><div class="line">        session.commit();                                                 </div><div class="line">    } <span class="keyword">finally</span> {                                                           </div><div class="line">        session.close();                                                  </div><div class="line">    }                                                                     </div><div class="line">}</div></pre></td></tr></table></figure>

<p>为什么执行增、删、改会删除缓存？<strong>首先增、删、改操作最终都会执行同一个方法实现，也就是<code>BaseExecutor.query()</code>方法。其次在这个方法中会直接去清除一级和二级缓存。</strong>看下面的源码简析。</p>
<blockquote>
<p>源码简析<br>当调用update方法时，最后会进入如下的方法中：</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// BaseExecutor update</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span>(MappedStatement ms, Object parameter) throws SQLException {                            </div><div class="line">    ErrorContext.instance().resource(ms.getResource()).activity(<span class="string">"executing an update"</span>).<span class="keyword">object</span>(ms.getId()); </div><div class="line">    <span class="keyword">if</span> (closed) <span class="keyword">throw</span> <span class="keyword">new</span> ExecutorException(<span class="string">"Executor was closed."</span>);                                       </div><div class="line">    <span class="comment">// 清空一级和二级缓存</span></div><div class="line">    clearLocalCache();                                                                                     </div><div class="line">    <span class="keyword">return</span> doUpdate(ms, parameter);                                                                        </div><div class="line">}</div></pre></td></tr></table></figure>

<p>其中<code>clearLocalCache</code>的代码为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearLocalCache</span>() {         </div><div class="line">    <span class="keyword">if</span> (!closed) {                        </div><div class="line">        localCache.clear();                 </div><div class="line">        localOutputParameterCache.clear();  </div><div class="line">    }                                     </div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="二级缓存">二级缓存</h3>
<p>二级缓存与一级缓存其机制相同，默认也是采用<code>PerpetualCache</code>，实际为HashMap 存储。<br><strong>不同在于二级缓存的 作用域为Mapper（ 即映射文件） ，并且可自定义存储源，如Ehcache。</strong></p>
<p>如何开启？<br>在SQL映射文件中加入：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">cache</span>/&gt;</span></div></pre></td></tr></table></figure>

<p>即可开启二级缓存。</p>
<p><strong>要注意，使用二级缓存的实体类必须序列化，并且一定要使用手动提交的方式！</strong></p>
<p>示例：<br>SQL映射为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;<span class="keyword">select</span> id=<span class="string">"selectUser"</span> parameterType=<span class="string">"int"</span> resultType=<span class="string">"UserSerialization"</span>&gt;                </div><div class="line">    <span class="keyword">select</span> * <span class="keyword">from</span> users <span class="keyword">where</span> id = <span class="preprocessor">#{id}                                                   </span></div><div class="line">&lt;/<span class="keyword">select</span>&gt;</div></pre></td></tr></table></figure>

<p>测试方法：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSecondCache1</span>() {                                            </div><div class="line">    SqlSessionFactory factory = getFactory();                               </div><div class="line">    SqlSession session1 = factory.openSession(<span class="keyword">false</span>);                       </div><div class="line">    SqlSession session2 = factory.openSession(<span class="keyword">false</span>);                       </div><div class="line">    String statement = <span class="string">"section09.SecondCacheMapper.selectUser"</span>;            </div><div class="line">    <span class="keyword">try</span> {                                                                   </div><div class="line">        <span class="comment">// 只发送一条查询语句                                                        </span></div><div class="line">        UserSerialization user1 = session1.selectOne(statement, <span class="number">2</span>);         </div><div class="line">        System.<span class="keyword">out</span>.println(user1);                                          </div><div class="line">        <span class="comment">// commit会设置Session对象的dirty属性为false                                 </span></div><div class="line">        session1.commit();                                                  </div><div class="line"> </div><div class="line">        UserSerialization user2 = session2.selectOne(statement, <span class="number">2</span>);         </div><div class="line">        System.<span class="keyword">out</span>.println(user2);                                          </div><div class="line">        session2.commit();                                                  </div><div class="line">    } <span class="keyword">finally</span> {                                                             </div><div class="line">        session1.close();                                                   </div><div class="line">        session2.close();                                                   </div><div class="line">    }                                                                       </div><div class="line">}</div></pre></td></tr></table></figure>

<p>从日志结果可以看到只发送了一条SQL语句，所以user2是从缓存中查询得到的。</p>
<p>为什么需要手动提交？<br>首先手动提交是会设置<code>SqlSession</code>的实现类<code>dirty</code>属性为false：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span>(<span class="keyword">boolean</span> force) {</div><div class="line">    <span class="keyword">try</span> {</div><div class="line">        executor.commit(isCommitOrRollbackRequired(force));</div><div class="line">        dirty = <span class="keyword">false</span>;</div><div class="line">    } <span class="keyword">catch</span> (Exception e) {</div><div class="line">        <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">"Error committing transaction.  Cause: "</span> + e, e);</div><div class="line">    } <span class="keyword">finally</span> {</div><div class="line">        ErrorContext.instance().reset();</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p><strong>当开启了二级缓存后，查询的流程会先从二级缓存查找，再从一级缓存中查找。</strong>其中从二级缓存查询时的流程会进入下列方法：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// CacheExecutor query</span></div><div class="line"><span class="keyword">public</span> <span class="subst">&lt;</span>E<span class="subst">&gt;</span> <span class="built_in">List</span><span class="subst">&lt;</span>E<span class="subst">&gt;</span> query(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler,</div><div class="line">    CacheKey key, BoundSql boundSql) throws SQLException {</div><div class="line">    <span class="comment">// 获取二级缓存 </span></div><div class="line">    <span class="keyword">Cache</span> <span class="keyword">cache</span> <span class="subst">=</span> ms<span class="built_in">.</span>getCache();</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">cache</span> <span class="subst">!=</span> <span class="built_in">null</span>) {</div><div class="line">        flushCacheIfRequired(ms);</div><div class="line">        <span class="keyword">if</span> (ms<span class="built_in">.</span>isUseCache() <span class="subst">&&</span> resultHandler <span class="subst">==</span> <span class="built_in">null</span>) {</div><div class="line">            ensureNoOutParams(ms, key, parameterObject, boundSql);</div><div class="line">            <span class="comment">// ditry为false则进入二级缓存查询</span></div><div class="line">            <span class="keyword">if</span> (<span class="subst">!</span>dirty) {</div><div class="line">                <span class="keyword">cache</span><span class="built_in">.</span>getReadWriteLock()<span class="built_in">.</span>readLock()<span class="built_in">.</span>lock();</div><div class="line">                try {</div><div class="line">                    <span class="comment">// 尝试从缓存中获取结果，如果能获取则直接返回</span></div><div class="line">                    @SuppressWarnings(<span class="string">"unchecked"</span>)</div><div class="line">                    <span class="built_in">List</span><span class="subst">&lt;</span>E<span class="subst">&gt;</span> cachedList <span class="subst">=</span> (<span class="built_in">List</span><span class="subst">&lt;</span>E<span class="subst">&gt;</span>) <span class="keyword">cache</span><span class="built_in">.</span>getObject(key);</div><div class="line">                    <span class="keyword">if</span> (cachedList <span class="subst">!=</span> <span class="built_in">null</span>) <span class="keyword">return</span> cachedList;</div><div class="line">                } finally {</div><div class="line">                    <span class="keyword">cache</span><span class="built_in">.</span>getReadWriteLock()<span class="built_in">.</span>readLock()<span class="built_in">.</span>unlock();</div><div class="line">                }</div><div class="line">            }</div><div class="line">            <span class="comment">// 二级缓存中没有则继续从一级缓存或者数据库获取</span></div><div class="line">            <span class="built_in">List</span><span class="subst">&lt;</span>E<span class="subst">&gt;</span> <span class="built_in">list</span> <span class="subst">=</span> delegate<span class="built_in">.</span><span class="subst">&lt;</span>E<span class="subst">&gt;</span> query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</div><div class="line">            tcm<span class="built_in">.</span>putObject(<span class="keyword">cache</span>, key, <span class="built_in">list</span>); <span class="comment">// issue #578. Query must be not synchronized to prevent deadlocks</span></div><div class="line">            <span class="keyword">return</span> <span class="built_in">list</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> delegate<span class="built_in">.</span><span class="subst">&lt;</span>E<span class="subst">&gt;</span>query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</div><div class="line">}</div></pre></td></tr></table></figure>





<h2 id="MyBatis与Spring集成">MyBatis与Spring集成</h2>
<h3 id="配置">配置</h3>
<p>配置项包括：</p>
<ul>
<li>DriverManagerDataSource，数据源管理器，因为要链接数据库，必须使用数据源管理器管理数据源；</li>
</ul>
<ul>
<li>SqlSessionFactoryBean，工厂类。注意Spring专门提供了方便集成的工厂类，这个类不是MyBatis包下的。同时需要为工厂类提供自动扫描管理的package包名和引用前面的数据源管理器；</li>
</ul>
<ul>
<li>MapperScannerConfigurer，映射文件管理类，自动管理映射文件和映射接口，并且引用前面的 SqlSessionFactoryBean 工厂 类；</li>
</ul>
<ul>
<li>DataSourceTransactionManager，事务管理器；</li>
</ul>
<ul>
<li>配置使用声明式事务管理。</li>
</ul>
<p>下面是集成时完整的配置内容：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">beans</span> <span class="attribute">xmlns</span>=<span class="value">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">    <span class="attribute">xmlns:xsi</span>=<span class="value">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">    <span class="attribute">xmlns:p</span>=<span class="value">"http://www.springframework.org/schema/p"</span></div><div class="line">    <span class="attribute">xmlns:context</span>=<span class="value">"http://www.springframework.org/schema/context"</span></div><div class="line">    <span class="attribute">xmlns:tx</span>=<span class="value">"http://www.springframework.org/schema/tx"</span></div><div class="line">    <span class="attribute">xsi:schemaLocation</span>=<span class="value">"</span></div><div class="line">        http://www.springframework.org/schema/beans</div><div class="line">        http://www.springframework.org/schema/beans/spring-beans-3.2.xsd</div><div class="line">        http://www.springframework.org/schema/context</div><div class="line">        http://www.springframework.org/schema/context/spring-context-3.2.xsd</div><div class="line">        http://www.springframework.org/schema/tx</div><div class="line">        http://www.springframework.org/schema/tx/spring-tx-3.2.xsd"&gt;</div><div class="line"> </div><div class="line">    <span class="comment">&lt;!-- 1. 配置数据源管理器 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"datasource"</span> <span class="attribute">class</span>=<span class="value">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"driverClassName"</span> <span class="attribute">value</span>=<span class="value">"com.mysql.jdbc.Driver"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"url"</span> <span class="attribute">value</span>=<span class="value">"jdbc:mysql://localhost:3306/mybatis"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"username"</span> <span class="attribute">value</span>=<span class="value">"root"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"password"</span> <span class="attribute">value</span>=<span class="value">"mysql"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">bean</span>&gt;</span>   </div><div class="line"> </div><div class="line">    <span class="comment">&lt;!-- 2. 配置SqlSessionFactory，注意这是Spring包下的。</span></div><div class="line">        里面包括数据库源和对自动管理实体类别名的目录 --&gt;</div><div class="line">    <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"factory"</span> <span class="attribute">class</span>=<span class="value">"org.mybatis.spring.SqlSessionFactoryBean"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"dataSource"</span> <span class="attribute">ref</span>=<span class="value">"datasource"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"typeAliasesPackage"</span> <span class="attribute">value</span>=<span class="value">"section09.bean"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">bean</span>&gt;</span></div><div class="line"> </div><div class="line">    <span class="comment">&lt;!-- 3. 配置映射文件和映射接口的目录 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"conf"</span> <span class="attribute">class</span>=<span class="value">"org.mybatis.spring.mapper.MapperScannerConfigurer"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"basePackage"</span> <span class="attribute">value</span>=<span class="value">"section09.mapper"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"sqlSessionFactory"</span> <span class="attribute">ref</span>=<span class="value">"factory"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">bean</span>&gt;</span></div><div class="line"> </div><div class="line">    <span class="comment">&lt;!-- 4. 配置事务管理器 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"tranxmanager"</span> <span class="attribute">class</span>=<span class="value">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"dataSource"</span> <span class="attribute">ref</span>=<span class="value">"datasource"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">bean</span>&gt;</span></div><div class="line"> </div><div class="line">    <span class="comment">&lt;!-- 5. 使用声明式事务 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">tx:annotation-driven</span> <span class="attribute">transaction-manager</span>=<span class="value">"tranxmanager"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">beans</span>&gt;</span></div></pre></td></tr></table></figure>

<h3 id="SQL语句和映射接口联合使用">SQL语句和映射接口联合使用</h3>
<p>和Spring集成后，可以把映射接口和SQL语句联合使用。<br>也就是Mapper接口的方法中不用声明SQL语句，而是在在映射文件中实现。但要关联方法和SQL语句必须注意2点：</p>
<ul>
<li>Mapper文件中，namespace必须与映射接口（Mapper.class）的全类名一致。</li>
<li>Mapper文件中，SQL语句的id必须与接口中的方法名一致。</li>
</ul>
<p>示例：<br>Mapper文件：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 映射文件和映射接口一起使用，namespace一定要为映射接口的全类名 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">mapper</span> <span class="attribute">namespace</span>=<span class="value">"section09.mapper.UserMapper"</span>&gt;</span></div><div class="line"> </div><div class="line">    <span class="comment">&lt;!-- id也必须和映射接口的方法名一致 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">insert</span> <span class="attribute">id</span>=<span class="value">"insertUser"</span> <span class="attribute">parameterType</span>=<span class="value">"User"</span>&gt;</span></div><div class="line">        insert into users(name, age) values(#{name}, #{age})</div><div class="line">    <span class="tag">&lt;/<span class="title">insert</span>&gt;</span></div><div class="line"> </div><div class="line">    <span class="tag">&lt;<span class="title">update</span> <span class="attribute">id</span>=<span class="value">"updateUser"</span> <span class="attribute">parameterType</span>=<span class="value">"User"</span>&gt;</span></div><div class="line">        update users set name = #{name}, age = #{age} where id = #{id}</div><div class="line">    <span class="tag">&lt;/<span class="title">update</span>&gt;</span></div><div class="line"> </div><div class="line">    <span class="tag">&lt;<span class="title">delete</span> <span class="attribute">id</span>=<span class="value">"deleteUser"</span> <span class="attribute">parameterType</span>=<span class="value">"int"</span>&gt;</span></div><div class="line">        delete from users where id = #{id}</div><div class="line">    <span class="tag">&lt;/<span class="title">delete</span>&gt;</span></div><div class="line"> </div><div class="line">    <span class="tag">&lt;<span class="title">select</span> <span class="attribute">id</span>=<span class="value">"getUser"</span> <span class="attribute">parameterType</span>=<span class="value">"int"</span> <span class="attribute">resultType</span>=<span class="value">"User"</span>&gt;</span></div><div class="line">        select id, name, age from users where id = #{id}</div><div class="line">    <span class="tag">&lt;/<span class="title">select</span>&gt;</span></div><div class="line"> </div><div class="line">    <span class="tag">&lt;<span class="title">select</span> <span class="attribute">id</span>=<span class="value">"getAllUsers"</span> <span class="attribute">resultType</span>=<span class="value">"User"</span>&gt;</span></div><div class="line">        select id, name, age from users</div><div class="line">    <span class="tag">&lt;/<span class="title">select</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">mapper</span>&gt;</span></div></pre></td></tr></table></figure>

<p>Mapper接口：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">interface</span> UserMapper {</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insertUser</span>(User user);</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> <span class="title">updateUser</span>(User user);</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> <span class="title">deleteUser</span>(User user);</div><div class="line">    <span class="keyword">public</span> User <span class="title">getUser</span>(<span class="keyword">int</span> id);</div><div class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title">getAllUsers</span>();</div><div class="line">}</div></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@RunWith</span>(SpringJUnit4ClassRunner.class)</div><div class="line"><span class="annotation">@ContextConfiguration</span>(<span class="string">"/applicationContext.xml"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTest</span> </span>{</div><div class="line"> </div><div class="line">    <span class="annotation">@Autowired</span></div><div class="line">    <span class="keyword">private</span> UserMapper mapper;</div><div class="line"> </div><div class="line">    <span class="annotation">@Test</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInsertUser</span>() {</div><div class="line">        User user = <span class="keyword">new</span> User(-<span class="number">1</span>, <span class="string">"SpringMyBatisInte"</span>, <span class="number">33</span>);</div><div class="line">        <span class="keyword">int</span> resultRow = mapper.insertUser(user);</div><div class="line">        System.out.println(resultRow);</div><div class="line">    }</div><div class="line">     </div><div class="line">    <span class="comment">// 其它方法的测试省略</span></div><div class="line">}</div></pre></td></tr></table></figure>

  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/MyBatis/">MyBatis</a>
  </div>




<div class="article-share" id="share">

  <div data-url="http://yoursite.com/2015/04/27/Java/MyBatis/MyBatis教程（二）/" data-title="MyBatis教程（二） | LC的笔记" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/04/27/Java/NIO/Buffer的基本用法/" title="Buffer的基本用法">
  <strong>PREVIOUS:</strong><br/>
  <span>
  Buffer的基本用法</span>
</a>
</div>


<div class="next">
<a href="/2015/04/27/Java/MyBatis/MyBatis教程（一）/"  title="MyBatis教程（一）">
 <strong>NEXT:</strong><br/> 
 <span>MyBatis教程（一）
</span>
</a>
</div>

</nav>

	
</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#CRUD操作"><span class="toc-number">1.</span> <span class="toc-text">CRUD操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用SQL映射文件"><span class="toc-number">1.1.</span> <span class="toc-text">使用SQL映射文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用映射接口"><span class="toc-number">1.2.</span> <span class="toc-text">使用映射接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#同时使用SQL映射文件和映射接口"><span class="toc-number">1.3.</span> <span class="toc-text">同时使用SQL映射文件和映射接口</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常用操作补充"><span class="toc-number">2.</span> <span class="toc-text">常用操作补充</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用独立的数据库配置文件"><span class="toc-number">2.1.</span> <span class="toc-text">使用独立的数据库配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#全类名的别名"><span class="toc-number">2.2.</span> <span class="toc-text">全类名的别名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#日志输出功能"><span class="toc-number">2.3.</span> <span class="toc-text">日志输出功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据库表字段和实体类属性名的映射"><span class="toc-number">2.4.</span> <span class="toc-text">数据库表字段和实体类属性名的映射</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#关联查询"><span class="toc-number">3.</span> <span class="toc-text">关联查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#一对一关联"><span class="toc-number">3.1.</span> <span class="toc-text">一对一关联</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一对多关联查询"><span class="toc-number">3.2.</span> <span class="toc-text">一对多关联查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一对一和一对多关联"><span class="toc-number">3.3.</span> <span class="toc-text">一对一和一对多关联</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模糊查询"><span class="toc-number">4.</span> <span class="toc-text">模糊查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用动态标签"><span class="toc-number">4.1.</span> <span class="toc-text">使用动态标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用\$获取参数值"><span class="toc-number">4.2.</span> <span class="toc-text">使用\$获取参数值</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#调用存储过程"><span class="toc-number">5.</span> <span class="toc-text">调用存储过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#缓存"><span class="toc-number">6.</span> <span class="toc-text">缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#一级缓存"><span class="toc-number">6.1.</span> <span class="toc-text">一级缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#什么时候清除缓存"><span class="toc-number">6.2.</span> <span class="toc-text">什么时候清除缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二级缓存"><span class="toc-number">6.3.</span> <span class="toc-text">二级缓存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MyBatis与Spring集成"><span class="toc-number">7.</span> <span class="toc-text">MyBatis与Spring集成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#配置"><span class="toc-number">7.1.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL语句和映射接口联合使用"><span class="toc-number">7.2.</span> <span class="toc-text">SQL语句和映射接口联合使用</span></a></li></ol></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  

  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Android/" title="Android">Android<sup>3</sup></a></li>
		
			<li><a href="/tags/Concurrent/" title="Concurrent">Concurrent<sup>7</sup></a></li>
		
			<li><a href="/tags/ConcurrentAPI/" title="ConcurrentAPI">ConcurrentAPI<sup>1</sup></a></li>
		
			<li><a href="/tags/Cookie-Session/" title="Cookie&amp;Session">Cookie&amp;Session<sup>2</sup></a></li>
		
			<li><a href="/tags/Hibernate/" title="Hibernate">Hibernate<sup>5</sup></a></li>
		
			<li><a href="/tags/JDBC/" title="JDBC">JDBC<sup>3</sup></a></li>
		
			<li><a href="/tags/JSP-Servlet/" title="JSP&amp;Servlet">JSP&amp;Servlet<sup>5</sup></a></li>
		
			<li><a href="/tags/Java/" title="Java">Java<sup>3</sup></a></li>
		
			<li><a href="/tags/Maven/" title="Maven">Maven<sup>4</sup></a></li>
		
			<li><a href="/tags/MyBatis/" title="MyBatis">MyBatis<sup>2</sup></a></li>
		
			<li><a href="/tags/NIO/" title="NIO">NIO<sup>6</sup></a></li>
		
			<li><a href="/tags/Network/" title="Network">Network<sup>2</sup></a></li>
		
			<li><a href="/tags/Oracle/" title="Oracle">Oracle<sup>6</sup></a></li>
		
			<li><a href="/tags/SQL/" title="SQL">SQL<sup>6</sup></a></li>
		
			<li><a href="/tags/Spring/" title="Spring">Spring<sup>5</sup></a></li>
		
			<li><a href="/tags/SpringMVC/" title="SpringMVC">SpringMVC<sup>4</sup></a></li>
		
			<li><a href="/tags/Struts2/" title="Struts2">Struts2<sup>5</sup></a></li>
		
			<li><a href="/tags/设计模式/" title="设计模式">设计模式<sup>12</sup></a></li>
		
		</ul>
</div>


  <div class="rsspart">
	<a href="null" target="_blank" title="rss">RSS</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font clearfix">
		
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2015 
		
		<a href="http://yoursite.com" target="_blank" title="zlc">zlc</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>






  </body>
</html>
