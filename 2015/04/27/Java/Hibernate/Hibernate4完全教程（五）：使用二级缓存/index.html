
 <!DOCTYPE HTML>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
  
    <title>Hibernate4完全教程（五）：使用二级缓存 | LC的笔记</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="zlc">
    
    <meta name="description" content="Hibernate的二级缓存
Hibernate中提供了两个级别的缓存：

第一级别的缓存是Session级别的缓存，它是属于事务范围的缓存。这一级别的缓存由 Hibernate 管理，调用Session的load等方法就会使用到这个缓存；
第二级别的缓存是SessionFactory级别的缓存，它">
    
    
    
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="LC的笔记" title="LC的笔记"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="LC的笔记">LC的笔记</a></h1>
				<h2 class="blog-motto">好记性不如烂笔头</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:yoursite.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/04/27/Java/Hibernate/Hibernate4完全教程（五）：使用二级缓存/" title="Hibernate4完全教程（五）：使用二级缓存" itemprop="url">Hibernate4完全教程（五）：使用二级缓存</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://yoursite.com" title="zlc">zlc</a>
    </p>
  <p class="article-time">
    <time datetime="2015-04-27T11:05:15.000Z" itemprop="datePublished">4月 27 2015</time>
    Updated:<time datetime="2015-04-27T11:05:15.000Z" itemprop="dateModified">4月 27 2015</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Hibernate的二级缓存"><span class="toc-number">1.</span> <span class="toc-text">Hibernate的二级缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用EHCache"><span class="toc-number">1.1.</span> <span class="toc-text">使用EHCache</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ehcache-xml配置文件"><span class="toc-number">1.2.</span> <span class="toc-text">ehcache.xml配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二级查询缓存"><span class="toc-number">1.3.</span> <span class="toc-text">二级查询缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#时间戳缓存区域（了解）"><span class="toc-number">1.4.</span> <span class="toc-text">时间戳缓存区域（了解）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Session管理"><span class="toc-number">2.</span> <span class="toc-text">Session管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Session与本地线程绑定"><span class="toc-number">2.1.</span> <span class="toc-text">Session与本地线程绑定</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreadLocalSessionContext和ThreadLocal"><span class="toc-number">2.2.</span> <span class="toc-text">ThreadLocalSessionContext和ThreadLocal</span></a></li></ol></li></ol>
		</div>
		
		<h2 id="Hibernate的二级缓存">Hibernate的二级缓存</h2>
<p>Hibernate中提供了两个级别的缓存：</p>
<ul>
<li>第一级别的缓存是<code>Session</code>级别的缓存，它是属于事务范围的缓存。这一级别的缓存由 Hibernate 管理，调用<code>Session</code>的<code>load</code>等方法就会使用到这个缓存；</li>
<li>第二级别的缓存是<code>SessionFactory</code>级别的缓存，它是属于进程范围的缓存。<strong>也就是<code>Session</code>关闭后还能还能不经过数据库重新获取前面获取过的记录</strong>。<br><code>SessionFactory</code>缓存又分为：<ul>
<li>内置缓存：Hibernate 自带的，不可卸载。通常在 Hibernate 的初始化阶段，Hibernate 会把映射元数据和预定义的SQL语句放到二级缓存中，映射元数据是映射文件 （.hbm.xml 文件） 中数据的复制。该内置缓存是只读的，一般不会操作它；</li>
<li>外置缓存：也称为<strong>二级缓存</strong>，是一个可配置的缓存插件。在默认情况下，<code>SessionFactory</code>不会启用这个缓存插件，需要手动添加二级缓存插件。</li>
</ul>
</li>
</ul>
<p><strong>适合放入二级缓存中的数据： 很少被修改或者 不是很重要的数据、允许出现偶尔的并发问题的数据。</strong></p>
<blockquote>
<p>Hibernate 常用的 缓存插件：</p>
</blockquote>
<ul>
<li>EHCache：可作为进程范围内的缓存，存放数据的物理介质可以使内存或硬盘，对 Hibernate 的查询缓存提供了支持；</li>
<li>OpenSymphony OSCache：可作为进程范围内的缓存，存放数据的物理介质可以使内存或硬盘，提供了丰富的缓存数据过期策略，对 Hibernate 的查询缓存提供了支持；</li>
<li>SwarmCache：可作为集群范围内的缓存，但不支持 Hibernate 的查询缓存；</li>
<li>JBossCache：可作为集群范围内的缓存，支持 Hibernate 的查询缓存。</li>
</ul>
<p>这里介绍性能最好的EHCache插件的使用。</p>
<h3 id="使用EHCache">使用EHCache</h3>
<p>（1）加入相关的jar包：<br>ehcache-core-2.4.3.jar<br>hibernate-ehcache-4.2.4.Final.jar<br>slf4j-api-1.6.1.jar</p>
<p>（2）在src目录下添加ehcache.xml文件，该文件是EHCache二级缓存的配置文件，后面会详细说明它的配置项，<strong>而且其实可以添加ehcache.xml配置文件</strong>。</p>
<p>（3）在Hibernate的应用配置文件hibernate.cfg.xml中添加开启二级缓存的配置项：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 启动二级缓存 --&gt;</span>                                                 </div><div class="line"><span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"cache.use_second_level_cache"</span>&gt;</span>true<span class="tag">&lt;/<span class="title">property</span>&gt;</span>   </div><div class="line"> </div><div class="line"><span class="comment">&lt;!-- 配置二级缓存的工厂类--&gt;</span>                                              </div><div class="line"><span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"hibernate.cache.region.factory_class"</span>&gt;</span>          </div><div class="line">    org.hibernate.cache.ehcache.EhCacheRegionFactory            </div><div class="line"><span class="tag">&lt;/<span class="title">property</span>&gt;</span></div></pre></td></tr></table></figure>

<p><strong>注意，二级缓存的工厂类是hibernate-core-xxx.jar包下的！</strong></p>
<p>（4）配置二级缓存生效的持久化类，这里有两种配置方法：</p>
<ul>
<li>一种同样是在hibernate.cfg.xml文件中配置，例如：</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 配置二级缓存生效的持久化类 --&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="title">class-cache</span> <span class="attribute">usage</span>=<span class="value">"read-write"</span> <span class="attribute">class</span>=<span class="value">"section07.Employee"</span>/&gt;</span>                         </div><div class="line"><span class="tag">&lt;<span class="title">class-cache</span> <span class="attribute">usage</span>=<span class="value">"read-write"</span> <span class="attribute">class</span>=<span class="value">"section07.Department"</span>/&gt;</span>                       </div><div class="line"><span class="comment">&lt;!-- Department类中的emps属性也需要配置 --&gt;</span>                                                    </div><div class="line"><span class="tag">&lt;<span class="title">collection-cache</span> <span class="attribute">usage</span>=<span class="value">"read-write"</span> <span class="attribute">collection</span>=<span class="value">"section07.Department.emps"</span>/&gt;</span></div></pre></td></tr></table></figure>

<p><strong>注意，如果希望Employee中的所有引用类型属性都支持二级缓存，则需要级联配置。例如Employee对象中包含了Department对象的引用，而Department对象中又包含了emps集合类型的属性，属性这3个都要配置Employee才能通过二级缓存一级一级的获取对象的引用。</strong></p>
<ul>
<li>另一种方法是在持久化类的映射文件中配置，例如：</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">// Employee映射文件中</div><div class="line"><span class="tag">&lt;<span class="title">class</span> <span class="attribute">name</span>=<span class="value">"Employee"</span> <span class="attribute">table</span>=<span class="value">"EMPLOYEES"</span>&gt;</span>  </div><div class="line">    <span class="comment">&lt;!-- 支持二级缓存 --&gt;</span>                        </div><div class="line">    <span class="tag">&lt;<span class="title">cache</span> <span class="attribute">usage</span>=<span class="value">"read-write"</span>/&gt;</span>            </div><div class="line"><span class="tag">&lt;/<span class="title">class</span>&gt;</span> </div><div class="line">// Department映射文件中</div><div class="line"><span class="tag">&lt;<span class="title">class</span> <span class="attribute">name</span>=<span class="value">"Department"</span> <span class="attribute">table</span>=<span class="value">"DEPARTMENTS"</span>&gt;</span>                              </div><div class="line">    <span class="comment">&lt;!-- 配置二级缓存 --&gt;</span>                                                        </div><div class="line">    <span class="tag">&lt;<span class="title">cache</span> <span class="attribute">usage</span>=<span class="value">"read-write"</span>/&gt;</span>                                            </div><div class="line">    <span class="tag">&lt;<span class="title">id</span> <span class="attribute">name</span>=<span class="value">"id"</span> <span class="attribute">type</span>=<span class="value">"java.lang.Integer"</span>&gt;</span>                                </div><div class="line">        <span class="tag">&lt;<span class="title">column</span> <span class="attribute">name</span>=<span class="value">"ID"</span> /&gt;</span>                                               </div><div class="line">        <span class="tag">&lt;<span class="title">generator</span> <span class="attribute">class</span>=<span class="value">"native"</span> /&gt;</span>                                       </div><div class="line">    <span class="tag">&lt;/<span class="title">id</span>&gt;</span>                                                                  </div><div class="line">    <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"name"</span> <span class="attribute">type</span>=<span class="value">"java.lang.String"</span> <span class="attribute">column</span>=<span class="value">"NAME"</span>/&gt;</span>          </div><div class="line">    <span class="tag">&lt;<span class="title">set</span> <span class="attribute">name</span>=<span class="value">"emps"</span> <span class="attribute">table</span>=<span class="value">"EMPLOYEES"</span> <span class="attribute">inverse</span>=<span class="value">"true"</span> <span class="attribute">lazy</span>=<span class="value">"true"</span>&gt;</span>    </div><div class="line">        <span class="tag">&lt;<span class="title">cache</span> <span class="attribute">usage</span>=<span class="value">"read-write"</span>/&gt;</span>                                        </div><div class="line">        <span class="tag">&lt;<span class="title">key</span>&gt;</span>                                                              </div><div class="line">            <span class="tag">&lt;<span class="title">column</span> <span class="attribute">name</span>=<span class="value">"DEPT_ID"</span> /&gt;</span>                                      </div><div class="line">        <span class="tag">&lt;/<span class="title">key</span>&gt;</span>                                                             </div><div class="line">        <span class="tag">&lt;<span class="title">one-to-many</span> <span class="attribute">class</span>=<span class="value">"Employee"</span> /&gt;</span>                                   </div><div class="line">    <span class="tag">&lt;/<span class="title">set</span>&gt;</span>                                                                 </div><div class="line"><span class="tag">&lt;/<span class="title">class</span>&gt;</span></div></pre></td></tr></table></figure>

<p><strong>同样在映射文件中配置启动二级缓存时也需要对每个引用类型属性进行配置，否则无法变量对象的引用时无法实现二级缓存。</strong></p>
<p>测试方法：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testHibernateCache</span>() {                                  </div><div class="line">    Employee employee = (Employee) session.<span class="keyword">get</span>(Employee.class, <span class="number">1</span>);  </div><div class="line">    System.<span class="keyword">out</span>.println(employee.getDept().getEmps().size());        </div><div class="line">    <span class="comment">// 关闭Session并重获取，这时候一级缓存中就没有对象了                                 </span></div><div class="line">    session.close();                                                </div><div class="line">    session = factory.openSession();                                </div><div class="line">    tranx = session.beginTransaction();                             </div><div class="line">    <span class="comment">// 再次获取对象，看是否输出SQL                                              </span></div><div class="line">    Employee employee2 = (Employee) session.<span class="keyword">get</span>(Employee.class, <span class="number">1</span>); </div><div class="line">    System.<span class="keyword">out</span>.println(employee2.getDept().getEmps().size());       </div><div class="line">}</div></pre></td></tr></table></figure>


<p>测试代码中通过<code>employee.getDept().getEmps()</code>先获取Employee的Department对象，然后获取Employee集合对象，所以要像前面说的那样配置Employee类、Department类和emps属性都开启二级缓存。</p>
<h3 id="ehcache-xml配置文件">ehcache.xml配置文件</h3>
<p>ehcache.xml是EHCache的配置文件，<strong>但项目中其实可以不添加</strong>。<br>该配置文件中可以使用的配置项为：</p>
<ul>
<li>disStrore： 指定一个目录存储缓存数据数据；</li>
</ul>
<ul>
<li>defaultCache：设置默认数据过期策略；</li>
</ul>
<ul>
<li>cache：设置命名数据过期策略，每个命名缓存代表一个<strong>缓存区域（region）</strong>。 在配置持久化类或者类的属性时，有一个region属性可以设置持久化类或属性放置在哪个缓存区域中。如果没有设置region属性则使用默认的缓存策略，即defaultCache。</li>
</ul>
<p>在defaultCache和cache元素中可以使用下面的属性设置具体策略：</p>
<ul>
<li>maxElementsInMemory ： 设置基于内存的缓存中可存放的对象最大数目；</li>
<li>eternal：设置对象是否为永久的，true表示永不过期。 此时将忽略timeToIdleSeconds 和 timeToLiveSeconds属性。默认值是false；</li>
<li>timeToIdleSeconds：设置对象空闲最长时间，以秒为单位，超过这个时间对象过期。 当对象过期时，EHCache会把它从缓存中清除。如果此值为0 ， 表示对象可以无限期地处于空闲状态。</li>
<li>timeToLiveSeconds：设置对象生存最长时间，超过这个时间，对象过期。 如果此值为0，表示对象可以无限期地存在于缓存中. 该属性值必须大于或等于 timeToIdleSeconds 属性值；</li>
<li>overflowToDisk：设置基于内存的缓存中的对象数目达到上限后，是否把溢出的对象写到基于硬盘的缓存中 。</li>
</ul>
<p>ehcache.xml文件示例：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">ehcache</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- </span></div><div class="line">        指定一个目录：当 EHCache 把数据写到硬盘上时, 将把数据写到这个目录下.</div><div class="line">    --&gt;    </div><div class="line">    <span class="tag">&lt;<span class="title">diskStore</span> <span class="attribute">path</span>=<span class="value">"d:\\tempDirectory"</span>/&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 设置缓存的默认数据过期策略 --&gt;</span>   </div><div class="line">    <span class="tag">&lt;<span class="title">defaultCache</span></span></div><div class="line">        <span class="attribute">maxElementsInMemory</span>=<span class="value">"10000"</span></div><div class="line">        <span class="attribute">eternal</span>=<span class="value">"false"</span></div><div class="line">        <span class="attribute">timeToIdleSeconds</span>=<span class="value">"120"</span></div><div class="line">        <span class="attribute">timeToLiveSeconds</span>=<span class="value">"120"</span></div><div class="line">        <span class="attribute">overflowToDisk</span>=<span class="value">"true"</span>/&gt;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="title">cache</span> <span class="attribute">name</span>=<span class="value">"Employee_cache"</span></span></div><div class="line">        <span class="attribute">maxElementsInMemory</span>=<span class="value">"1"</span></div><div class="line">        <span class="attribute">eternal</span>=<span class="value">"false"</span></div><div class="line">        <span class="attribute">timeToIdleSeconds</span>=<span class="value">"300"</span></div><div class="line">        <span class="attribute">timeToLiveSeconds</span>=<span class="value">"600"</span></div><div class="line">        <span class="attribute">overflowToDisk</span>=<span class="value">"true"</span>/&gt;</div><div class="line"> </div><div class="line">    <span class="tag">&lt;<span class="title">cache</span> <span class="attribute">name</span>=<span class="value">"Department.emps_cache"</span></span></div><div class="line">        <span class="attribute">maxElementsInMemory</span>=<span class="value">"1000"</span></div><div class="line">        <span class="attribute">eternal</span>=<span class="value">"true"</span></div><div class="line">        <span class="attribute">timeToIdleSeconds</span>=<span class="value">"0"</span></div><div class="line">        <span class="attribute">timeToLiveSeconds</span>=<span class="value">"0"</span></div><div class="line">        <span class="attribute">overflowToDisk</span>=<span class="value">"false"</span>/&gt;</div><div class="line"><span class="tag">&lt;/<span class="title">ehcache</span>&gt;</span></div></pre></td></tr></table></figure>

<h3 id="二级查询缓存">二级查询缓存</h3>
<p>查询缓存使用于如下场合：</p>
<ul>
<li>应用程序运行时经常使用查询语句；</li>
<li>很少对与查询语句检索到的数据进行插入，删除和更新等修改操作。</li>
</ul>
<p>配置二级缓存并设置了开启二级缓存的持久化类后，使用<code>Session</code>的<code>get</code>方法获取的<strong>对象一般是缓存生效的</strong>（例如上面示例中获取<code>employee.getDept().getEmps()</code>）。<strong> 但如果使用HQL或者QBC等方式查询对象的集合时，二级缓存默认是没有开启的。</strong>例如：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">List&lt;Employee&gt;</span> employees = session.createQuery(<span class="string">"FROM Employee"</span>).list();</span></div></pre></td></tr></table></figure>

<p>要开启二级查询缓存，需要3步设置：</p>
<ul>
<li>配置文件开启二级缓存并开启查询缓存：</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 启动二级缓存 --&gt;</span>                                                  </div><div class="line"><span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"cache.use_second_level_cache"</span>&gt;</span>true<span class="tag">&lt;/<span class="title">property</span>&gt;</span>    </div><div class="line"><span class="comment">&lt;!-- 启动查询缓存 --&gt;</span>                                                  </div><div class="line"><span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"cache.use_query_cache"</span>&gt;</span>true<span class="tag">&lt;/<span class="title">property</span>&gt;</span>           </div><div class="line"><span class="comment">&lt;!-- 配置二级缓存的工厂类--&gt;</span>                                               </div><div class="line"><span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"cache.region.factory_class"</span>&gt;</span>                     </div><div class="line">    org.hibernate.cache.ehcache.EhCacheRegionFactory             </div><div class="line"><span class="tag">&lt;/<span class="title">property</span>&gt;</span></div></pre></td></tr></table></figure>

<ul>
<li>相关的类和属性用<strong>cache</strong>元素配置为支持二级缓存；</li>
</ul>
<ul>
<li>调用<code>Query</code>或者<code>Criteria</code>借口的的<code>setCacheable(true)</code>方法。</li>
</ul>
<p>示例：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryCache</span>() {                                            </div><div class="line">    Query query = session.createQuery(<span class="string">"FROM Employee"</span>);                   </div><div class="line"></div><div class="line">    query.setCacheable(<span class="keyword">true</span>);                                             </div><div class="line">    List&lt;Employee&gt; employees = query.list();                              </div><div class="line">    System.<span class="keyword">out</span>.println(Arrays.asList(employees));                         </div><div class="line">    <span class="comment">// 关闭Session并重新获取                                                     </span></div><div class="line">    session.close();                                                      </div><div class="line">    session = factory.openSession();                                      </div><div class="line">    tranx = session.beginTransaction();                                   </div><div class="line">    <span class="comment">// 使用缓存中的数据</span></div><div class="line"></div><div class="line">    Query query2 = session.createQuery(<span class="string">"FROM Employee"</span>);                  </div><div class="line">    query2.setCacheable(<span class="keyword">true</span>);                                            </div><div class="line">    List&lt;Employee&gt; employees2 = query2.list();                            </div><div class="line">    System.<span class="keyword">out</span>.println(Arrays.asList(employees2));                        </div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="时间戳缓存区域（了解）">时间戳缓存区域（了解）</h3>
<p>时间戳缓存区域存放了对于查询结果相关的表进行插入，更新或删除操作的时间戳。Hibernate 通过时间戳缓存区域来判断被缓存的查询结果是否过期，其运行过程如下：</p>
<ul>
<li>T1 时刻执行查询操作，把查询结果存放在 QueryCache 区域，记录该区域的时间戳为 T1；</li>
<li>T2 时刻对查询结果相关的表进行更新操作，Hibernate 把 T2 时刻存放在 UpdateTimestampCache 区域；</li>
<li>T3 时刻执行查询结果前，先比较 QueryCache 区域的时间戳和 UpdateTimestampCache 区域的时间戳，若 T2 &gt;T1，那么就丢弃原先存放在 QueryCache 区域的查询结果，重新到数据库中查询数据，再把结果存放到 QueryCache 区域; 若 T2 &lt; T1，直接从 QueryCache 中获得查询结果。</li>
</ul>
<h2 id="Session管理">Session管理</h2>
<p>Hibernate提供了三种管理Session对象的方法，在配置文件中，使用 <strong>hibernate.current_session_context_class</strong>属性配置Session的管理方式。Session的管理方式和对应的配置项分别为 ：</p>
<ul>
<li>Session对象的生命周期与本地线程绑定，使用<strong>thread</strong>；</li>
<li>Session对象的生命周期与JTA事务绑定，使用<strong>jta</strong>；</li>
<li>Hibernate委托程序管理Session对象的生命周期，使用<strong>managed</strong>。</li>
</ul>
<h3 id="Session与本地线程绑定">Session与本地线程绑定</h3>
<p>下面介绍常用的Session与本地线程绑定的方式，配置项为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;<span class="keyword">property</span> <span class="property">name</span>=<span class="string">"current_session_context_class"</span>&gt;thread&lt;/<span class="keyword">property</span>&gt;</div></pre></td></tr></table></figure>

<p>Session与本地线程绑定有下列的特点：</p>
<ul>
<li>当一个线程（threadA）第一次调用<code>SessionFactory</code>对象的<code>getCurrentSession()</code>方法时，该方法会创建一个新的Session（sessionA）对象，把该对象与threadA绑定，并将sessionA返回；</li>
</ul>
<ul>
<li>当threadA再次调用<code>SessionFactory</code>对象的<code>getCurrentSession()</code>方法时，该方法将返回sessionA对象；</li>
</ul>
<ul>
<li>当threadA提交sessionA对象关联的事务时，Hibernate会自动<code>flush()</code>sessionA对象的缓存，然后提交事务，关闭sessionA对象。当threadA撤销sessionA对象关联的事务时，也会自动关闭sessionA对象；</li>
</ul>
<ul>
<li>若threadA再次调用<code>SessionFactory</code>对象的<code>getCurrentSession()</code>方法时，该方法会又创建一个新的Session（sessionB）对象，把该对象与threadA绑定，并将sessionB返回。</li>
</ul>
<p>示例：<br>在编写DAO的CRUD方法时，如果把Session作为方法的参数传入，那么DAO的上层（Service或者Action）就需要准备这个Session对象，这时候上层对象就会与Hibernate的API紧密耦合：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 若需要传入Session对象作为参，则意味着上一层(Service)需要获取到 Session对象。                       </span></div><div class="line"><span class="comment">// 这样会和Hibernate的API紧密耦合，所以不推荐                                              </span></div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span>(Session session, Department dept) {                        </div><div class="line">    session.save(dept);                                                     </div><div class="line">}</div></pre></td></tr></table></figure>

<p>这时候可以把Session交给当前线程管理，并提供一个工具类获取当前线程的Session：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> HibernateUtils {</div><div class="line">    <span class="keyword">private</span> <span class="title">HibernateUtils</span>() {}</div><div class="line"> </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> HibernateUtils instance = <span class="keyword">new</span> HibernateUtils();</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HibernateUtils <span class="title">getInstance</span>() {</div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="keyword">private</span> SessionFactory factory = <span class="keyword">null</span>;</div><div class="line"> </div><div class="line">    <span class="keyword">private</span> SessionFactory <span class="title">getSessionFactory</span>() {</div><div class="line">        <span class="keyword">if</span>(factory == <span class="keyword">null</span>) {</div><div class="line">            Configuration config = <span class="keyword">new</span> Configuration().configure();</div><div class="line">            ServiceRegistry registry =</div><div class="line">                    <span class="keyword">new</span> ServiceRegistryBuilder().applySettings(config.getProperties()).buildServiceRegistry();</div><div class="line">            factory = config.buildSessionFactory(registry);</div><div class="line">        }</div><div class="line">        <span class="keyword">return</span> factory;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> Session <span class="title">getSession</span>() {</div><div class="line">        <span class="keyword">return</span> getSessionFactory().getCurrentSession();</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>在DAO的方法中就可以直接使用Session对象：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">/<span class="keyword">*</span>                                                                      </div><div class="line"> <span class="keyword">*</span> 把Session交给本地线程管理，这样的好处是：                                             </div><div class="line"> <span class="keyword">*</span> 1. 不用传入Session对象；                                                    </div><div class="line"> <span class="keyword">*</span> 2. 多个DAO的方法可以使用同一个Session，也就是多个DAO的方法公用一个事务；                         </div><div class="line"> <span class="keyword">*</span> 3. 在Session提交或回滚事务时，Session关闭。                                       </div><div class="line"> <span class="keyword">*</span>/                                                                     </div><div class="line">public void save(Department dept) {                                     </div><div class="line">    Session session = HibernateUtils.getInstance().getSession();        </div><div class="line">    session.save(dept);                                                 </div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="ThreadLocalSessionContext和ThreadLocal">ThreadLocalSessionContext和ThreadLocal</h3>
<p>本地管理Session的实现核心类是<code>ThreadLocalSessionContext</code>，这个类中有一个关键的属性：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Map&gt; context = <span class="keyword">new</span> ThreadLocal&lt;Map&gt;();</div></pre></td></tr></table></figure>

<p>ThreadLocal的介绍：<br><code>ThreadLocal</code>可以为每个线程保持各自独立的一个副本，它有下列重要的方法：</p>
<ul>
<li>public void set(T value)<br>设置当前线程副本中的线程局部变量的值。</li>
</ul>
<ul>
<li>public T get()<br>返回此线程局部变量的当前线程副本中的值。 如果这是线程第一次调用该方法，则创建并初始化此副本。</li>
</ul>
<ul>
<li>public void remove()<br>移除此线程局部变量的值。</li>
</ul>
<ul>
<li>protected T initialValue()<br>返回此线程局部变量的当前线程的初始值。</li>
</ul>
<p><strong>ThreadLocal 实例通常是类中的 private static 字段，它希望将状态与某一个线程相关联。</strong></p>
<p>测试示例：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">class SequenceNumber {</div><div class="line">    <span class="keyword">private</span> ThreadLocal&lt;Integer&gt; context = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</div><div class="line">    <span class="keyword">public</span> Integer <span class="title">getNumber</span>() {</div><div class="line">        Integer number = context.<span class="keyword">get</span>();</div><div class="line">        <span class="keyword">if</span>(number == <span class="keyword">null</span>) {</div><div class="line">            number = <span class="keyword">new</span> Random().nextInt();;</div><div class="line">            context.<span class="keyword">set</span>(number);</div><div class="line">        }</div><div class="line">        <span class="keyword">return</span> number;</div><div class="line">    }</div><div class="line">}</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> ThreadLocalTest {</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(String[] args) {</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) {</div><div class="line">            <span class="keyword">new</span> Thread() {</div><div class="line">                SequenceNumber sn = <span class="keyword">new</span> SequenceNumber();</div><div class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() {</div><div class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) {</div><div class="line">                        System.<span class="keyword">out</span>.println(Thread.currentThread().getName() +</div><div class="line">                                <span class="string">" number: ["</span> + sn.getNumber() + <span class="string">"]"</span>);</div><div class="line">                    }</div><div class="line">                }</div><div class="line">            }.start();</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p><code>ThreadLocalSessionContext</code>使用了<code>ThreadLocal</code>保存Session对象，所以在同一个线程中获取到的Session对象是同一个，下面把<code>ThreadLocalSessionContext</code>中对Session操作的核心代码提取为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> ThreadLocaSessionContextlTest {</div><div class="line">    <span class="keyword">private</span> ThreadLocal&lt;Map&lt;SessionFactory, Session&gt;&gt; context = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</div><div class="line"> </div><div class="line">    <span class="comment">// 获取和当前线程绑定的Session对象</span></div><div class="line">    <span class="keyword">public</span> final Session <span class="title">currentSession</span>() {</div><div class="line">        Map&lt;SessionFactory, Session&gt; sessionMap = context.<span class="keyword">get</span>();</div><div class="line">        <span class="keyword">if</span>(sessionMap == <span class="keyword">null</span>) {</div><div class="line">            Session session = buildOrObtainSession();</div><div class="line">            sessionMap = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">            sessionMap.put(factory(), session);</div><div class="line">            <span class="keyword">return</span> session;</div><div class="line">        }</div><div class="line">        <span class="keyword">return</span> sessionMap.<span class="keyword">get</span>(factory());</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// 实例化一个Session对象</span></div><div class="line">    <span class="keyword">private</span> Session <span class="title">buildOrObtainSession</span>() {</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    }</div><div class="line"> </div><div class="line">    <span class="comment">// 返回SessionFactory实例作为ThreadLocal中绑定的Map对象的键值</span></div><div class="line">    <span class="keyword">public</span> SessionFactory <span class="title">factory</span>() {</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/Hibernate/">Hibernate</a>
  </div>




<div class="article-share" id="share">

  <div data-url="http://yoursite.com/2015/04/27/Java/Hibernate/Hibernate4完全教程（五）：使用二级缓存/" data-title="Hibernate4完全教程（五）：使用二级缓存 | LC的笔记" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/04/27/Java/Hibernate/Hibernate4完全教程（四）：继承映射、检索策略和检索方式/" title="Hibernate4完全教程（四）：继承映射、检索策略和检索方式">
  <strong>PREVIOUS:</strong><br/>
  <span>
  Hibernate4完全教程（四）：继承映射、检索策略和检索方式</span>
</a>
</div>


<div class="next">
<a href="/2015/04/27/Java/Hibernate/Hibernate4完全教程（二）：常用API和方法介绍/"  title="Hibernate4完全教程（二）：常用API和方法介绍">
 <strong>NEXT:</strong><br/> 
 <span>Hibernate4完全教程（二）：常用API和方法介绍
</span>
</a>
</div>

</nav>

	
</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Hibernate的二级缓存"><span class="toc-number">1.</span> <span class="toc-text">Hibernate的二级缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用EHCache"><span class="toc-number">1.1.</span> <span class="toc-text">使用EHCache</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ehcache-xml配置文件"><span class="toc-number">1.2.</span> <span class="toc-text">ehcache.xml配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二级查询缓存"><span class="toc-number">1.3.</span> <span class="toc-text">二级查询缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#时间戳缓存区域（了解）"><span class="toc-number">1.4.</span> <span class="toc-text">时间戳缓存区域（了解）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Session管理"><span class="toc-number">2.</span> <span class="toc-text">Session管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Session与本地线程绑定"><span class="toc-number">2.1.</span> <span class="toc-text">Session与本地线程绑定</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreadLocalSessionContext和ThreadLocal"><span class="toc-number">2.2.</span> <span class="toc-text">ThreadLocalSessionContext和ThreadLocal</span></a></li></ol></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  

  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Android/" title="Android">Android<sup>3</sup></a></li>
		
			<li><a href="/tags/Concurrent/" title="Concurrent">Concurrent<sup>7</sup></a></li>
		
			<li><a href="/tags/ConcurrentAPI/" title="ConcurrentAPI">ConcurrentAPI<sup>1</sup></a></li>
		
			<li><a href="/tags/Cookie-Session/" title="Cookie&amp;Session">Cookie&amp;Session<sup>2</sup></a></li>
		
			<li><a href="/tags/Hibernate/" title="Hibernate">Hibernate<sup>5</sup></a></li>
		
			<li><a href="/tags/JDBC/" title="JDBC">JDBC<sup>3</sup></a></li>
		
			<li><a href="/tags/JSP-Servlet/" title="JSP&amp;Servlet">JSP&amp;Servlet<sup>5</sup></a></li>
		
			<li><a href="/tags/Java/" title="Java">Java<sup>3</sup></a></li>
		
			<li><a href="/tags/Maven/" title="Maven">Maven<sup>4</sup></a></li>
		
			<li><a href="/tags/MyBatis/" title="MyBatis">MyBatis<sup>2</sup></a></li>
		
			<li><a href="/tags/NIO/" title="NIO">NIO<sup>6</sup></a></li>
		
			<li><a href="/tags/Network/" title="Network">Network<sup>2</sup></a></li>
		
			<li><a href="/tags/Oracle/" title="Oracle">Oracle<sup>6</sup></a></li>
		
			<li><a href="/tags/SQL/" title="SQL">SQL<sup>6</sup></a></li>
		
			<li><a href="/tags/Spring/" title="Spring">Spring<sup>5</sup></a></li>
		
			<li><a href="/tags/SpringMVC/" title="SpringMVC">SpringMVC<sup>4</sup></a></li>
		
			<li><a href="/tags/Struts2/" title="Struts2">Struts2<sup>5</sup></a></li>
		
			<li><a href="/tags/设计模式/" title="设计模式">设计模式<sup>12</sup></a></li>
		
		</ul>
</div>


  <div class="rsspart">
	<a href="null" target="_blank" title="rss">RSS</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font clearfix">
		
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2015 
		
		<a href="http://yoursite.com" target="_blank" title="zlc">zlc</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>






  </body>
</html>
