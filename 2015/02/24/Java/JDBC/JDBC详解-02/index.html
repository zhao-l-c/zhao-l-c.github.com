
 <!DOCTYPE HTML>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
  
    <title>JDBC详解-02 | LC的笔记</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="zlc">
    
    <meta name="description" itemprop="description" content="下面介绍了JDBC中的一些常用操作，包括获取插入记录的主键、操作BLOB类型数据、批量插入。还有介绍了事务操作和隔离级别。">
    
    
    
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="LC的笔记" title="LC的笔记"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="LC的笔记">LC的笔记</a></h1>
				<h2 class="blog-motto">好记性不如烂笔头</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:yoursite.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/02/24/Java/JDBC/JDBC详解-02/" title="JDBC详解-02" itemprop="url">JDBC详解-02</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://yoursite.com" title="zlc">zlc</a>
    </p>
  <p class="article-time">
    <time datetime="2015-02-24T05:24:13.000Z" itemprop="datePublished">2月 24 2015</time>
    Updated:<time datetime="2015-02-24T05:26:48.000Z" itemprop="dateModified">2月 24 2015</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#补充常用的JDBC操作"><span class="toc-number">1.</span> <span class="toc-text">补充常用的JDBC操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#获取插入记录的主键"><span class="toc-number">1.1.</span> <span class="toc-text">获取插入记录的主键</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#操作Blob数据类型"><span class="toc-number">1.2.</span> <span class="toc-text">操作Blob数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Oracle的LOB类型"><span class="toc-number">1.2.1.</span> <span class="toc-text">Oracle的LOB类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MySQL的BLOB"><span class="toc-number">1.2.2.</span> <span class="toc-text">MySQL的BLOB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JDBC插入BLOB类型数据"><span class="toc-number">1.2.3.</span> <span class="toc-text">JDBC插入BLOB类型数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JDBC获取BLOB类型数据"><span class="toc-number">1.2.4.</span> <span class="toc-text">JDBC获取BLOB类型数据</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#批量插入操作"><span class="toc-number">1.3.</span> <span class="toc-text">批量插入操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据库事务"><span class="toc-number">2.</span> <span class="toc-text">数据库事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#事务的ACID属性"><span class="toc-number">2.1.</span> <span class="toc-text">事务的ACID属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JDBC提供事务操作"><span class="toc-number">2.2.</span> <span class="toc-text">JDBC提供事务操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据库的隔离级别"><span class="toc-number">2.3.</span> <span class="toc-text">数据库的隔离级别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#直接修改数据库的隔离级别"><span class="toc-number">2.4.</span> <span class="toc-text">直接修改数据库的隔离级别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JDBC修改隔离级别"><span class="toc-number">2.5.</span> <span class="toc-text">JDBC修改隔离级别</span></a></li></ol></li></ol>
		</div>
		
		<h2 id="补充常用的JDBC操作">补充常用的JDBC操作</h2>
<h3 id="获取插入记录的主键">获取插入记录的主键</h3>
<p>如果主键是数据库自动生成的话，当执行插入操作时，<code>PreparedStatement</code>提供了一个方法<code>getGeneratedKeys</code>获取插入记录的主键。</p>
<p>示例代码如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getGeneratedKeys</span>() {                                         </div><div class="line">    String sql = <span class="string">"insert into user(name, age) values('hello', 22)"</span>;      </div><div class="line">    Connection conn = JDBCUtil.getConnection();                          </div><div class="line">    PreparedStatement ps = <span class="keyword">null</span>;                                         </div><div class="line">    ResultSet rs = <span class="keyword">null</span>;                                                 </div><div class="line">    <span class="keyword">try</span> {                                                                </div><div class="line">        ps = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS);</div><div class="line">        ps.executeUpdate();                                              </div><div class="line">        <span class="comment">// 获取自动生成主键                                                      </span></div><div class="line">        rs = ps.getGeneratedKeys();                                      </div><div class="line">        <span class="keyword">if</span>(rs.next()) {                                                  </div><div class="line">            <span class="comment">// 注意，返回的主键id是java.lang.Long类型的                              </span></div><div class="line">            Long id = rs.getLong(<span class="number">1</span>);                                     </div><div class="line">            System.<span class="keyword">out</span>.println(id);                                      </div><div class="line">        }                                                                </div><div class="line">    } <span class="keyword">catch</span> (SQLException e) {                                           </div><div class="line">        e.printStackTrace();                                             </div><div class="line">    } <span class="keyword">finally</span> {                                                          </div><div class="line">        JDBCUtil.release(conn, ps, rs);                                  </div><div class="line">    }                                                                    </div><div class="line">}</div></pre></td></tr></table></figure>

<p>包括两个步骤：</p>
<ul>
<li><code>Connection</code>方法创建<code>PreparedStatement</code>时需要声明返回主键：</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">ps </span>=<span class="string"> conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS);</span></div></pre></td></tr></table></figure>

<ul>
<li><code>PreparedStatement</code>使用<code>getGeneratedKeys</code>方法返回结果集，结果集中就是主键：</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">rs = ps.getGeneratedKeys();                   </div><div class="line"><span class="keyword">if</span>(rs.<span class="keyword">next</span>()) {                               </div><div class="line">    <span class="comment">// 注意，返回的主键id是java.lang.Long类型的           </span></div><div class="line">    <span class="keyword">Long</span> id = rs.getLong(<span class="number">1</span>);                  </div><div class="line">    System.out.<span class="keyword">println</span>(id);                   </div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="操作Blob数据类型">操作Blob数据类型</h3>
<h4 id="Oracle的LOB类型">Oracle的LOB类型</h4>
<p>LOB，即Large Objects（大对象），是用来存储大量的二进制和文本数据的一种数据类型（一个LOB字段可存储可多达4GB的数据，参考Oracle部分对数据类型的说明）。<br>Oracle支持三种类型的内部LOB： </p>
<ul>
<li>BLOB，二进制数据。</li>
<li>CLOB，单字节字符数据。</li>
<li>NCLOB，多字节字符数据。 </li>
</ul>
<p>CLOB和NCLOB类型适用于存储超长的文本数据，BLOB字段适用于存储大量的二进制数据，如图像、视频、音频，文件等。 </p>
<p>Oracle的Blob字段比long字段的性能要好。 Oracle的BLOB字段由两部分组成：数据（值）和指向数据的指针（定位器）。</p>
<h4 id="MySQL的BLOB">MySQL的BLOB</h4>
<p>MySQL中，BLOB是一个二进制大型对象，是一个可以存储大量数据的容器，它能容纳不同大小的数据。 MySQL的四种BLOB类型（除了在存储的最大信息量上不同外，他们是等同的）：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>大小</th>
</tr>
</thead>
<tbody>
<tr>
<td>TinyBlob</td>
<td>255</td>
</tr>
<tr>
<td>Blob</td>
<td>65K</td>
</tr>
<tr>
<td>MediumBlob</td>
<td>16M</td>
</tr>
<tr>
<td>LongBlog</td>
<td>4G</td>
</tr>
</tbody>
</table>
<p> 实际使用中根据需要存入的数据大小定义不同的BLOB类型。需要注意的是：如果存储的文件过大，数据库的性能会下降。</p>
<h4 id="JDBC插入BLOB类型数据">JDBC插入BLOB类型数据</h4>
<p>插入BLOB类型数据和其它类型数据一样，只不过在设置SQL语句的绑定变量时使用<code>setBlob</code>方法，该方法第二个参数为<code>InputStream</code>类型的数据。</p>
<p>示例代码如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInsertBlob</span>() {                                 </div><div class="line">    String sql = <span class="string">"insert into picture(data, name) values(?, ?)"</span>;</div><div class="line">    Connection conn = JDBCUtil.getConnection();                </div><div class="line">    PreparedStatement ps = <span class="keyword">null</span>;                               </div><div class="line">    <span class="keyword">try</span> {                                                      </div><div class="line">        ps = conn.prepareStatement(sql);                       </div><div class="line">        InputStream <span class="keyword">is</span> = <span class="keyword">new</span> FileInputStream(<span class="string">"hacker.jpg"</span>);    </div><div class="line">        ps.setBlob(<span class="number">1</span>, <span class="keyword">is</span>);                                     </div><div class="line">        ps.setString(<span class="number">2</span>, <span class="string">"hacker.jpg"</span>);                         </div><div class="line">        <span class="keyword">int</span> updateRow = ps.executeUpdate();                    </div><div class="line">        System.<span class="keyword">out</span>.println(updateRow);                         </div><div class="line">    } <span class="keyword">catch</span> (SQLException | FileNotFoundException e) {         </div><div class="line">        e.printStackTrace();                                   </div><div class="line">    } <span class="keyword">finally</span> {                                                </div><div class="line">        JDBCUtil.release(conn, ps, <span class="keyword">null</span>);                      </div><div class="line">    }                                                           </div><div class="line">}</div></pre></td></tr></table></figure>

<h4 id="JDBC获取BLOB类型数据">JDBC获取BLOB类型数据</h4>
<p>获取BLOB类型数据时，调用结果集的<code>getBlob</code>就行，返回的是<code>java.sql.Blob</code>类型的数据，然后可以获取<code>java.sql.Blob</code>数据的二级制流，再进行其它转换。示例代码：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">@Test                                                                         </div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSelectBlob</span>() {                                                </div><div class="line">    String sql = <span class="string">"select id, data, name from picture where id = 2 for update"</span>;</div><div class="line">    Connection conn = JDBCUtil.getConnection();                               </div><div class="line">    PreparedStatement ps = <span class="keyword">null</span>;                                              </div><div class="line">    ResultSet rs = <span class="keyword">null</span>;                                                      </div><div class="line">    <span class="keyword">try</span> {                                                                     </div><div class="line">        ps = conn.prepareStatement(sql);                                      </div><div class="line">        rs = ps.executeQuery();                                               </div><div class="line"> </div><div class="line">        <span class="keyword">if</span>(rs.next()) {                                                       </div><div class="line">            Blob blob = rs.getBlob(<span class="number">2</span>);                                        </div><div class="line">            InputStream <span class="keyword">is</span> = blob.getBinaryStream();                          </div><div class="line">            OutputStream os = <span class="keyword">new</span> FileOutputStream(<span class="string">"hacker_out.jpg"</span>);         </div><div class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];                                   </div><div class="line">            <span class="keyword">int</span> len = <span class="number">0</span>;                                                      </div><div class="line">            <span class="keyword">while</span>((len = <span class="keyword">is</span>.read(buffer)) != -<span class="number">1</span>) {                            </div><div class="line">                os.write(buffer, <span class="number">0</span>, len);                                     </div><div class="line">            }                                                                 </div><div class="line">            os.close();                                                       </div><div class="line">            <span class="keyword">is</span>.close();                                                       </div><div class="line">        }                                                                     </div><div class="line">    } <span class="keyword">catch</span> (SQLException | IOException e) {                                  </div><div class="line">        e.printStackTrace();                                                  </div><div class="line">    } <span class="keyword">finally</span> {                                                               </div><div class="line">        JDBCUtil.release(conn, ps, rs);                                       </div><div class="line">    }                                                                         </div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="批量插入操作">批量插入操作</h3>
<p><code>PreparedStatement</code>有一个功能就是可以存放批量的SQL语句，然后一次提交数据库执行，这样可以明显提高效率。<br>示例代码：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testBatchInsert</span>() {                             </div><div class="line">    Connection conn = JDBCUtil.getConnection();             </div><div class="line">    PreparedStatement ps = <span class="keyword">null</span>;                            </div><div class="line">    String sql = <span class="string">"insert into user(name, age) values('batch',  20)"</span>;</div><div class="line"> </div><div class="line">    <span class="keyword">try</span> {                                                   </div><div class="line">        ps = conn.prepareStatement(sql);                    </div><div class="line">        JDBCUtil.beginTranx(conn);                          </div><div class="line"> </div><div class="line">        <span class="keyword">long</span> begin = System.currentTimeMillis();            </div><div class="line">        <span class="keyword">int</span> batchCount = <span class="number">100000</span>;                            </div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; batchCount; i++) {               </div><div class="line">            <span class="comment">// 添加SQL操作记录                                    </span></div><div class="line">            ps.addBatch();                                  </div><div class="line">            <span class="comment">// 当达到300条SQL记录时，执行批量操作                         </span></div><div class="line">            <span class="keyword">if</span>((i + <span class="number">1</span>) % <span class="number">300</span> == <span class="number">0</span>) {                        </div><div class="line">                ps.executeBatch();                          </div><div class="line">                <span class="comment">// 一定要清空SQL记录                               </span></div><div class="line">                ps.clearBatch();                            </div><div class="line">            }                                               </div><div class="line">        }                                                   </div><div class="line">        <span class="comment">// 最后务必把剩余的记录也批量执行                                  </span></div><div class="line">        <span class="keyword">if</span>(batchCount % <span class="number">300</span> != <span class="number">0</span>) {                         </div><div class="line">            ps.executeBatch();                              </div><div class="line">            ps.clearBatch();                                </div><div class="line">        }                                                   </div><div class="line">        JDBCUtil.commit(conn);                              </div><div class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();              </div><div class="line">        System.<span class="keyword">out</span>.println(end - begin); <span class="comment">// 9356            </span></div><div class="line">    } <span class="keyword">catch</span> (SQLException e) {                              </div><div class="line">        e.printStackTrace();                                </div><div class="line">        JDBCUtil.rollback(conn);                            </div><div class="line">    } <span class="keyword">finally</span> {                                             </div><div class="line">        JDBCUtil.release(conn, ps, <span class="keyword">null</span>);                   </div><div class="line">    }                                                       </div><div class="line">}</div></pre></td></tr></table></figure>


<p>包括3个基本步骤：</p>
<ul>
<li>执行<code>PreparedStatement</code>的<code>addBatch()</code>方法添加SQL语句；</li>
<li>达到一定数量后调用<code>executeBatch</code>进行批量执行；</li>
<li>最后要调用<code>clearBatch</code>方法清空SQL语句。</li>
</ul>
<h2 id="数据库事务">数据库事务</h2>
<h3 id="事务的ACID属性">事务的ACID属性</h3>
<ul>
<li>原子性（Atomicity）原子性是指事务是一个不可分割的工作单位，事务中的操作要么都发生，要么都不发生。 </li>
<li>一致性（Consistency）事务必须使数据库从一个一致性状态变换到另外一个一致性状态。 </li>
<li>隔离性（Isolation）事务的隔离性是指一个事务的执行不能被其他事务干扰，即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不能互相干扰。</li>
<li>持久性（Durability）持久性是指一个事务一旦被提交，它对数据库中数据的改变就是永久性的，接下来的其他操作和数据库故障不应该对其有任何影响</li>
</ul>
<h3 id="JDBC提供事务操作">JDBC提供事务操作</h3>
<p>使用JDBC控制事务操作的一般步骤为：</p>
<ul>
<li><ol>
<li>取消默认提交<code>conn.setAutoCommit(false);</code>；</li>
</ol>
</li>
<li><ol>
<li>如果数据库操作成功，进行手动提交<code>conn.commit();</code>；</li>
</ol>
</li>
<li><ol>
<li>如果数据库操作失败，进行回滚操作<code>conn.rollback();</code>。</li>
</ol>
</li>
</ul>
<p><code>conn</code>为<code>Connection</code>实例对象。</p>
<p>示例代码：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTransaction</span>() {                                   </div><div class="line">    String sql = <span class="string">"insert into user(name, age) values('jane', 33)"</span>;</div><div class="line">    Connection conn = JDBCUtil.getConnection();                   </div><div class="line">    PreparedStatement ps = <span class="keyword">null</span>;                                  </div><div class="line">    <span class="keyword">try</span> {                                                         </div><div class="line">        ps = conn.prepareStatement(sql);                          </div><div class="line">        <span class="comment">// 取消自动提交                                                 </span></div><div class="line">        conn.setAutoCommit(<span class="keyword">false</span>);                                </div><div class="line">        <span class="keyword">int</span> updateRow = ps.executeUpdate();                       </div><div class="line">        updateRow = <span class="number">10</span>/<span class="number">0</span>;                                         </div><div class="line">        <span class="comment">// 手动提交事务                                                 </span></div><div class="line">        conn.commit();                                            </div><div class="line">        System.<span class="keyword">out</span>.println(updateRow);                            </div><div class="line">    } <span class="keyword">catch</span> (Exception e) {                                       </div><div class="line">        System.<span class="keyword">out</span>.println(e.getMessage());                       </div><div class="line">        <span class="keyword">try</span> {                                                     </div><div class="line">            <span class="comment">// 发生异常下需要回滚事务                                        </span></div><div class="line">            conn.rollback();                                      </div><div class="line">            System.<span class="keyword">out</span>.println(<span class="string">"事务回滚"</span>);                           </div><div class="line">        } <span class="keyword">catch</span> (SQLException e1) {                               </div><div class="line">            e1.printStackTrace();                                 </div><div class="line">        }                                                         </div><div class="line">    } <span class="keyword">finally</span> {                                                   </div><div class="line">        JDBCUtil.release(conn, ps, <span class="keyword">null</span>);                         </div><div class="line">    }                                                              </div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="数据库的隔离级别">数据库的隔离级别</h3>
<p>对于同时运行的多个事务，当这些事务访问数据库中相同的数据时，如果没有采取必要的隔离机制，就会导致各种并发问题：</p>
<ul>
<li><p>脏读： 对于两个操作 T1，T2。T1 读取了已经被 T2 更新但还没有被提交的字段。之后，若 T2 回滚，T1读取的内容就是临时且无效的。 <strong>这是一定要避免的。</strong></p>
</li>
<li><p>不可重复读：对于两个操作 T1，T2。T1 读取了一个字段，然后 T2 更新了该字段。 之后，T1再次读取同一个字段，值就不同了。 </p>
</li>
<li><p>幻读：对于两个操作T1，T2。T1 从一个表中读取了一个字段，然后 T2 在该表中插入了一些新的行。 之后，如果 T1 再次读取同一个表，就会多出几行。</p>
</li>
</ul>
<p><strong>注意，脏读是一定要避免的，剩余2种都可以存在。</strong></p>
<p>标准数据库提供的 4 种事务隔离级别，越往下并发性能越差，但越安全：</p>
<p>其中：<br>Oracle 支持的2种事务隔离级别：READ COMMITED，SERIALIZABLE。Oracle 默认的事务隔离级别为: READ COMMITED。<br>Mysql 支持全部4种事务隔离级别。Mysql 默认的事务隔离级别为: REPEATABLE READ。</p>
<h3 id="直接修改数据库的隔离级别">直接修改数据库的隔离级别</h3>
<p>对MySQL数据库：<br>MySQL数据库有一个全局变量<code>@@tx_isolation</code>表示隔离级别，所以查询当前的隔离级别：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="operator"><span class="keyword">SELECT</span> @@tx_isolation;</span></div></pre></td></tr></table></figure>


<p>设置当前连接MySQL的隔离级别（当前会话）：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="operator"><span class="keyword">set</span>  <span class="keyword">transaction</span> <span class="keyword">isolation</span> <span class="keyword">level</span> <span class="keyword">read</span> committed;</span></div></pre></td></tr></table></figure>


<p>设置MySQL的全局隔离级别：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="operator"><span class="keyword">set</span> <span class="keyword">global</span> <span class="keyword">transaction</span> <span class="keyword">isolation</span> <span class="keyword">level</span> <span class="keyword">read</span> committed;</span></div></pre></td></tr></table></figure>

<h3 id="JDBC修改隔离级别">JDBC修改隔离级别</h3>
<p>在JDBC中可以调用<code>Connection</code>的<code>setTransactionIsolation</code>方法修改隔离级别。</p>
<p>例如，下面这个示例是在MySQL下，一个连接更新一行记录，但不提交；然后另外一个连接修改隔离级别为读未提交（TRANSACTION_READ_UNCOMMITTED），这时候就能把前一个连接已更新未提交的数据读取出来：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testREAD_UNCOMMITED</span>() {                                                        </div><div class="line">    <span class="comment">// 获取2个数据库连接                                                                           </span></div><div class="line">    Connection conn1 = JDBCUtil.getConnection();                                           </div><div class="line">    PreparedStatement ps1 = <span class="keyword">null</span>;                                                          </div><div class="line">    String sql1 = <span class="string">"update user set age = 100 where id = 1"</span>;                                </div><div class="line"> </div><div class="line">    Connection conn2 = JDBCUtil.getConnection();                                           </div><div class="line">    PreparedStatement ps2 = <span class="keyword">null</span>;                                                          </div><div class="line">    String sql2 = <span class="string">"select name, age from user where id = 1"</span>;                               </div><div class="line">    ResultSet rs = <span class="keyword">null</span>;                                                                   </div><div class="line">    <span class="keyword">try</span> {                                                                                  </div><div class="line">        <span class="comment">// 操作A负责更新数据，所以不用修改隔离级别                                                            </span></div><div class="line">        conn1.setAutoCommit(<span class="keyword">false</span>);                                                        </div><div class="line">        <span class="comment">// 操作B要对操作A更新的数据“脏读”，所以修改隔离级别为“读未提交”                                               </span></div><div class="line">        conn2.setTransactionIsolation(Connection.TRANSACTION_READ_UNCOMMITTED);            </div><div class="line"> </div><div class="line">        <span class="comment">// 操作A执行更新，但为提交                                                                    </span></div><div class="line">        ps1 = conn1.prepareStatement(sql1);                                                </div><div class="line">        ps1.executeUpdate();                                                               </div><div class="line"> </div><div class="line">        <span class="comment">// 操作B查询操作A已更新未提交的数据                                                               </span></div><div class="line">        ps2 = conn2.prepareStatement(sql2);                                                </div><div class="line">        rs = ps2.executeQuery();                                                           </div><div class="line">        <span class="keyword">if</span>(rs.next()) {                                                                    </div><div class="line">            String name = rs.getString(<span class="number">1</span>);                                                 </div><div class="line">            <span class="keyword">int</span> age = rs.getInt(<span class="number">2</span>);                                                        </div><div class="line">            System.<span class="keyword">out</span>.println(<span class="string">"name:"</span> + name + <span class="string">", age:"</span> + age);                           </div><div class="line">        }                                                                                  </div><div class="line">        <span class="comment">// 迫使操作A无法成功提交                                                                     </span></div><div class="line">        <span class="keyword">int</span> updateRow = <span class="number">10</span> / <span class="number">0</span>;                                                            </div><div class="line">        conn1.commit();                                                                    </div><div class="line">    } <span class="keyword">catch</span>(Exception e) {                                                                 </div><div class="line">        <span class="keyword">try</span> {                                                                              </div><div class="line">            conn1.rollback();                                                              </div><div class="line">            System.<span class="keyword">out</span>.println(<span class="string">"回滚"</span>);                                                      </div><div class="line">        } <span class="keyword">catch</span> (SQLException e1) {                                                        </div><div class="line">            e1.printStackTrace();                                                          </div><div class="line">        }                                                                                  </div><div class="line">    } <span class="keyword">finally</span> {                                                                            </div><div class="line">        JDBCUtil.release(conn1, ps1, <span class="keyword">null</span>);                                                </div><div class="line">    }                                                                                      </div><div class="line">}</div></pre></td></tr></table></figure>




  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/Java/">Java</a><a href="/tags/JDBC/">JDBC</a>
  </div>




<div class="article-share" id="share">

  <div data-url="http://yoursite.com/2015/02/24/Java/JDBC/JDBC详解-02/" data-title="JDBC详解-02 | LC的笔记" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/02/24/Java/JDBC/JDBC详解-03/" title="JDBC详解-03">
  <strong>PREVIOUS:</strong><br/>
  <span>
  JDBC详解-03</span>
</a>
</div>


<div class="next">
<a href="/2015/02/24/Database/Oracle/Oracle基础-06：视图和其它数据库对象/"  title="Oracle基础-06：视图和其它数据库对象.md">
 <strong>NEXT:</strong><br/> 
 <span>Oracle基础-06：视图和其它数据库对象.md
</span>
</a>
</div>

</nav>

	
</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#补充常用的JDBC操作"><span class="toc-number">1.</span> <span class="toc-text">补充常用的JDBC操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#获取插入记录的主键"><span class="toc-number">1.1.</span> <span class="toc-text">获取插入记录的主键</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#操作Blob数据类型"><span class="toc-number">1.2.</span> <span class="toc-text">操作Blob数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Oracle的LOB类型"><span class="toc-number">1.2.1.</span> <span class="toc-text">Oracle的LOB类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MySQL的BLOB"><span class="toc-number">1.2.2.</span> <span class="toc-text">MySQL的BLOB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JDBC插入BLOB类型数据"><span class="toc-number">1.2.3.</span> <span class="toc-text">JDBC插入BLOB类型数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JDBC获取BLOB类型数据"><span class="toc-number">1.2.4.</span> <span class="toc-text">JDBC获取BLOB类型数据</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#批量插入操作"><span class="toc-number">1.3.</span> <span class="toc-text">批量插入操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据库事务"><span class="toc-number">2.</span> <span class="toc-text">数据库事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#事务的ACID属性"><span class="toc-number">2.1.</span> <span class="toc-text">事务的ACID属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JDBC提供事务操作"><span class="toc-number">2.2.</span> <span class="toc-text">JDBC提供事务操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据库的隔离级别"><span class="toc-number">2.3.</span> <span class="toc-text">数据库的隔离级别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#直接修改数据库的隔离级别"><span class="toc-number">2.4.</span> <span class="toc-text">直接修改数据库的隔离级别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JDBC修改隔离级别"><span class="toc-number">2.5.</span> <span class="toc-text">JDBC修改隔离级别</span></a></li></ol></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  

  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			<li><a href="/tags/JDBC/" title="JDBC">JDBC<sup>3</sup></a></li>
		
			<li><a href="/tags/Java/" title="Java">Java<sup>3</sup></a></li>
		
			<li><a href="/tags/Oracle/" title="Oracle">Oracle<sup>6</sup></a></li>
		
			<li><a href="/tags/SQL/" title="SQL">SQL<sup>6</sup></a></li>
		
		</ul>
</div>


  <div class="rsspart">
	<a href="null" target="_blank" title="rss">RSS</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font clearfix">
		
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2015 
		
		<a href="http://yoursite.com" target="_blank" title="zlc">zlc</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>






  </body>
</html>
